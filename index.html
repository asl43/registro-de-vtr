<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa da ForÃ§a â€” Controle de Unidades</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.04);--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,Helvetica,Arial}
    body{margin:0;background:linear-gradient(180deg,#06202a 0%,#071425 100%);color:#e6eef6;min-height:100vh;padding:24px}
    .app{width:100%;max-width:1400px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:12px}
    h1{font-size:20px;margin:0}
    h2{font-size:18px;margin:12px 0 8px}
    h3{font-size:15px;margin:8px 0;color:var(--accent)}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.6);margin-bottom:14px}
    
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
    input[type=text],input[type=datetime-local],select,input[type=tel],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    textarea{resize:vertical;min-height:80px}
    
    .row{display:flex;gap:12px;margin-bottom:12px}
    .col{flex:1}
    .col-auto{flex:0 0 auto}
    
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#022;cursor:pointer;font-weight:600;font-size:13px;transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
    button.danger{background:var(--danger);color:white}
    button.success{background:var(--success);color:white}
    button.small{padding:6px 10px;font-size:12px}
    
    .multi-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;max-height:300px;overflow-y:auto;padding:12px;background:var(--glass);border-radius:8px}
    .unit-checkbox{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;cursor:pointer;transition:background 0.2s}
    .unit-checkbox:hover{background:rgba(255,255,255,0.02)}
    .unit-checkbox input{cursor:pointer}
    .unit-checkbox label{cursor:pointer;margin:0;color:#e6eef6}
    
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
    .stat-card{background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:10px;padding:16px;text-align:center}
    .stat-value{font-size:32px;font-weight:700;color:var(--accent);margin:8px 0}
    .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    
    .alert-badge{background:var(--danger);color:white;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-left:8px;animation:pulse 2s infinite}
    
    .search-filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
    .search-box{flex:1;min-width:200px}
    
    .units-grid{display:grid;gap:14px}
    .unit-card{background:rgba(6,182,212,0.05);border:1px solid rgba(6,182,212,0.2);border-radius:10px;padding:14px}
    .unit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .unit-title{font-weight:600;font-size:16px;color:var(--accent)}
    
    .vtr-list{margin-top:12px}
    .vtr-item{background:var(--glass);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:12px;margin-bottom:10px;transition:all 0.3s}
    .vtr-item.alert{border-color:var(--danger);box-shadow:0 0 10px rgba(239,68,68,0.3)}
    .vtr-item.hidden{display:none}
    .vtr-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
    .vtr-id{font-weight:600;color:#e6eef6;font-size:15px}
    .vtr-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .vtr-service{display:inline-block;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;background:rgba(16,185,129,0.2);color:var(--success)}
    .j-counter{display:inline-flex;gap:4px;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;background:rgba(245,158,11,0.2);color:var(--warning)}
    
    .crew-list{margin-top:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px}
    .crew-member{font-size:12px;padding:4px 0;color:var(--muted)}
    .crew-member strong{color:#e6eef6}
    
    .empenhos-timeline{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06)}
    .empenho-entry{display:flex;align-items:flex-start;gap:10px;padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px}
    .empenho-time{color:var(--accent);font-weight:600;min-width:70px;font-size:12px}
    .empenho-info{flex:1}
    .empenho-label{color:#e6eef6;font-weight:600;font-size:13px}
    .empenho-details{font-size:11px;color:var(--muted);margin-top:4px}
    .empenho-duration{color:var(--warning);font-weight:600;font-size:12px;min-width:80px;text-align:right}
    .empenho-current{color:var(--success);animation:pulse 2s infinite}
    
    .protocol-badge{background:rgba(139,92,246,0.2);color:#a78bfa;padding:3px 6px;border-radius:3px;font-size:10px;font-weight:600;display:inline-block;margin-top:2px}
    
    .vtr-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
    
    .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .small{font-size:12px;color:var(--muted)}
    
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
    
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
    .modal.active{display:flex}
    .modal-content{background:var(--card);border-radius:12px;padding:24px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;margin:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:18px;font-weight:600}
    .modal-close{background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px}
    
    .crew-input-group{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.05)}
    .crew-input-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .crew-input-header h4{margin:0;font-size:13px;color:var(--accent)}
    
    .session-list{max-height:400px;overflow-y:auto}
    .session-item{background:var(--glass);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all 0.2s}
    .session-item:hover{background:rgba(6,182,212,0.1);border-color:var(--accent)}
    .session-title{font-weight:600;color:#e6eef6;margin-bottom:4px}
    .session-meta{font-size:11px;color:var(--muted)}
    
    .chart-container{background:var(--glass);border-radius:8px;padding:16px;margin-bottom:16px}
    canvas{max-height:300px}
    
    .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.1)}
    .tab{padding:10px 16px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:14px;font-weight:600;border-bottom:2px solid transparent;transition:all 0.2s}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    @media (max-width:700px){.row{flex-direction:column}.dashboard-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ğŸš” Mapa da ForÃ§a â€” Controle de Unidades</h1>
      <div style="display:flex;gap:8px">
        <button id="openSessionsBtn" class="ghost small">ğŸ“ SessÃµes</button>
        <button id="openStatsBtn" class="ghost small">ğŸ“Š EstatÃ­sticas</button>
      </div>
    </header>

    <!-- TELA 1: SeleÃ§Ã£o de unidades -->
    <section class="card" id="screen1">
      <h2>Passo 1 â€” InformaÃ§Ãµes da OperaÃ§Ã£o</h2>
      <div class="row">
        <div class="col">
          <label>Nome do Operador *</label>
          <input id="operatorName" type="text" placeholder="Seu nome completo" required />
        </div>
        <div class="col">
          <label>Data e Hora de InÃ­cio *</label>
          <input id="dateTime" type="datetime-local" required />
        </div>
      </div>

      <div style="margin-top:16px">
        <label>Selecione as Unidades para Controlar *</label>
        <div class="multi-select" id="unitsMultiSelect"></div>
      </div>

      <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
        <div class="small">Selecione pelo menos uma unidade</div>
        <button id="toStep2">Iniciar Controle â†’</button>
      </div>
    </section>

    <!-- TELA 2: Controle das unidades -->
    <section id="screen2" style="display:none">
      <!-- Dashboard -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
          <div>
            <div class="chip">ğŸ‘¤ <strong id="opSummary"></strong></div>
            <div class="chip" style="margin-left:8px">ğŸ“… <strong id="dtSummary"></strong></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="exportPdf" class="ghost small">ğŸ“„ PDF</button>
            <button id="exportCsv" class="ghost small">ğŸ“Š CSV</button>
            <button id="saveLocal" class="success small">ğŸ’¾ Salvar</button>
            <button id="finishBtn" class="danger small">Finalizar</button>
          </div>
        </div>

        <div class="dashboard-grid" id="dashboardStats"></div>
      </div>

      <!-- Busca e Filtros -->
      <div class="card">
        <div class="search-filter-bar">
          <div class="search-box">
            <input type="text" id="searchVtr" placeholder="ğŸ” Buscar viatura..." />
          </div>
          <select id="filterService">
            <option value="">Todos os ServiÃ§os</option>
            <option value="ORDINARIO">ORDINÃRIO</option>
            <option value="SEG">SEG</option>
            <option value="POG">POG</option>
            <option value="OPERAÃ‡ÃƒO">OPERAÃ‡ÃƒO</option>
          </select>
          <select id="filterUnit">
            <option value="">Todas as Unidades</option>
          </select>
        </div>
      </div>

      <div class="units-grid" id="unitsContainer"></div>
    </section>

    <!-- MODAL: VTR -->
    <div class="modal" id="vtrModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="modalTitle">Adicionar Viatura</div>
          <button class="modal-close" onclick="closeVtrModal()">Ã—</button>
        </div>
        
        <div>
          <label>IdentificaÃ§Ã£o da Viatura *</label>
          <input id="modalVtrId" type="text" placeholder="Ex: VTR-001, GuarniÃ§Ã£o 01" />
        </div>

        <div style="margin-top:12px">
          <label>Tipo de ServiÃ§o *</label>
          <select id="modalServiceType">
            <option value="ORDINARIO">ORDINÃRIO</option>
            <option value="SEG">SEG</option>
            <option value="POG">POG</option>
            <option value="OPERAÃ‡ÃƒO">OPERAÃ‡ÃƒO</option>
          </select>
        </div>

        <div style="margin-top:16px">
          <h3 style="margin-bottom:12px">Equipe da Viatura (atÃ© 5 membros)</h3>
          <div id="crewInputsContainer"></div>
          <button id="addCrewMember" class="ghost small" style="margin-top:8px">+ Adicionar Membro</button>
        </div>

        <div style="margin-top:12px">
          <label>Telefone de Contato</label>
          <input id="modalVtrPhone" type="tel" placeholder="(92) 9xxxx-xxxx" />
        </div>

        <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
          <button class="ghost" onclick="closeVtrModal()">Cancelar</button>
          <button id="saveVtrBtn" class="success">Salvar Viatura</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Empenho J -->
    <div class="modal" id="empenhoModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Registrar Empenho J</div>
          <button class="modal-close" onclick="closeEmpenhoModal()">Ã—</button>
        </div>
        
        <div class="small" style="margin-bottom:12px;background:rgba(6,182,212,0.1);padding:8px;border-radius:6px">
          Viatura: <strong id="modalVtrName"></strong>
        </div>

        <div>
          <label>Empenho J *</label>
          <select id="modalEmpenhoJ"></select>
        </div>

        <div style="margin-top:12px">
          <label>NÃºmero de Protocolo</label>
          <input id="modalProtocol" type="text" placeholder="Ex: 2024-12345" />
        </div>

        <div style="margin-top:12px">
          <label>AÃ§Ãµes Empregadas</label>
          <textarea id="modalActions" placeholder="Descreva as aÃ§Ãµes realizadas..."></textarea>
        </div>

        <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
          <button class="ghost" onclick="closeEmpenhoModal()">Cancelar</button>
          <button id="saveEmpenhoBtn" class="success">Registrar Empenho</button>
        </div>
      </div>
    </div>

    <!-- MODAL: SessÃµes -->
    <div class="modal" id="sessionsModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">ğŸ“ HistÃ³rico de SessÃµes</div>
          <button class="modal-close" onclick="closeSessionsModal()">Ã—</button>
        </div>
        <div class="session-list" id="sessionsList"></div>
      </div>
    </div>

    <!-- MODAL: EstatÃ­sticas -->
    <div class="modal" id="statsModal">
      <div class="modal-content" style="max-width:900px">
        <div class="modal-header">
          <div class="modal-title">ğŸ“Š EstatÃ­sticas e AnÃ¡lises</div>
          <button class="modal-close" onclick="closeStatsModal()">Ã—</button>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="switchTab('charts')">ğŸ“ˆ GrÃ¡ficos</button>
          <button class="tab" onclick="switchTab('performance')">â±ï¸ Desempenho</button>
        </div>

        <div class="tab-content active" id="tab-charts">
          <div class="chart-container">
            <h3>DistribuiÃ§Ã£o de Empenhos por Tipo</h3>
            <canvas id="chartEmpenhos"></canvas>
          </div>
          <div class="chart-container">
            <h3>Empenhos por HorÃ¡rio</h3>
            <canvas id="chartHorario"></canvas>
          </div>
        </div>

        <div class="tab-content" id="tab-performance">
          <div id="performanceStats"></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const units = {
      '25DIP': '25 CICOM','11DIP': '11 CICOM','28DIP': '28 CICOM','29DIP': '29 CICOM',
      '01DIP': '1 CICOM','02DIP': '2 CICOM','03DIP': '3 CICOM','04DIP': '4 CICOM',
      '05DIP': '5 CICOM','06DIP': '6 CICOM','07DIP': '7 CICOM','08DIP': '8 CICOM',
      '09DIP': '9 CICOM','10DIP': '10 CICOM','12DIP': '12 CICOM','13DIP': '13 CICOM',
      '14DIP': '14 CICOM','15DIP': '15 CICOM','16DIP': '16 CICOM','17DIP': '17 CICOM',
      '18DIP': '18 CICOM','19DIP': '19 CICOM','20DIP': '20 CICOM','21DIP': '21 CICOM',
      '22DIP': '22 CICOM','23DIP': '23 CICOM','24DIP': '24 CICOM','26DIP': '26 CICOM',
      '27DIP': '27 CICOM','30DIP': '30 CICOM',
      'CPA NORTE': 'CPA NORTE','CPA SUL': 'CPA SUL','CPA LESTE': 'CPA LESTE','CPA OESTE': 'CPA OESTE',
      'CPA C. SUL/C. OESTE': 'CPA C. SUL/C. OESTE',
      'FT': 'FT','BPTRAN': 'BPTRAN','CPTUR': 'CPTUR','RMP': 'RMP','CICLO': 'CICLO',
      'ROCAM': 'ROCAM','CHOQUE': 'CHOQUE','MARTE': 'MARTE','RPMON': 'RPMON','CIPCÃƒES': 'CIPCÃƒES',
      'COE': 'COE','BPAMB': 'BPAMB','CECOPOM': 'CECOPOM','GRAER': 'GRAER','BPG': 'BPG','NPPM': 'NPPM'
    };

    const empenhosJ = [
      {value:'J1',text:'J1: Atividade Fim'},{value:'J2',text:'J2: Atividade administrativa'},
      {value:'J3',text:'J3: SubstituiÃ§Ã£o de GuarniÃ§Ã£o PM'},{value:'J4',text:'J4: RefeiÃ§Ã£o'},
      {value:'J5',text:'J5: Abastecimento'},{value:'J6',text:'J6: Limpeza de viatura'},
      {value:'J7',text:'J7: ManutenÃ§Ã£o mecÃ¢nica'},{value:'J8',text:'J8: Necessidades FisiolÃ³gicas'},
      {value:'J9',text:'J9: Deslocamento para ocorrÃªncia'},{value:'J10',text:'J10: Chegada no local da ocorrÃªncia'},
      {value:'J11',text:'J11: SaÃ­da do local da ocorrÃªncia'},{value:'J12',text:'J12: GuarniÃ§Ã£o na base'},
      {value:'J15',text:'J15: OperaÃ§Ã£o Policial Militar'}
    ];

    const ALERT_THRESHOLDS = {J10:30,J9:20,J1:60};

    let session = {operator:'',datetime:'',selectedUnits:[],id:null};
    let unitsData = {};
    let editingVtr = null;
    let currentVtrForEmpenho = null;
    let timerInterval = null;
    let alertsShown = new Set();

    // ====== InicializaÃ§Ã£o ======
    (function init(){
      const multiSelect = document.getElementById('unitsMultiSelect');
      Object.entries(units).forEach(([k,v])=>{
        const div = document.createElement('div');
        div.className = 'unit-checkbox';
        div.innerHTML = `<input type="checkbox" id="unit_${k}" value="${k}"><label for="unit_${k}">${v}</label>`;
        multiSelect.appendChild(div);
      });

      const modalEmpenhoJ = document.getElementById('modalEmpenhoJ');
      empenhosJ.forEach(e=>{
        const opt = document.createElement('option');
        opt.value = e.value;
        opt.textContent = e.text;
        modalEmpenhoJ.appendChild(opt);
      });

      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dateTime').value = now.toISOString().slice(0,16);
    })();

    // ====== Passo 1 â†’ Passo 2 ======
    document.getElementById('toStep2').addEventListener('click', ()=>{
      const op = document.getElementById('operatorName').value.trim();
      const dt = document.getElementById('dateTime').value;
      const selected = Array.from(document.querySelectorAll('#unitsMultiSelect input:checked')).map(cb=>cb.value);

      if(!op || !dt){
        alert('Preencha o nome do operador e a data/hora.');
        return;
      }
      if(selected.length === 0){
        alert('Selecione pelo menos uma unidade para controlar.');
        return;
      }

      session.operator = op;
      session.datetime = dt;
      session.selectedUnits = selected;
      session.id = Date.now();

      selected.forEach(uk=>{
        if(!unitsData[uk]) unitsData[uk] = {vtrs:[]};
      });

      document.getElementById('opSummary').textContent = op;
      document.getElementById('dtSummary').textContent = new Date(dt).toLocaleString('pt-BR');

      const filterUnit = document.getElementById('filterUnit');
      filterUnit.innerHTML = '<option value="">Todas as Unidades</option>';
      selected.forEach(uk=>{
        const opt = document.createElement('option');
        opt.value = uk;
        opt.textContent = units[uk];
        filterUnit.appendChild(opt);
      });

      document.getElementById('screen1').style.display = 'none';
      document.getElementById('screen2').style.display = 'block';

      renderUnits();
      updateDashboard();
      startTimers();
      loadFromLocal();
    });

    // ====== Dashboard ======
    function updateDashboard(){
      let totalVtrs = 0;
      let totalEmpenhos = 0;
      let empenhoCounts = {};
      let activeVtrs = 0;

      session.selectedUnits.forEach(uk=>{
        const vtrs = unitsData[uk]?.vtrs || [];
        totalVtrs += vtrs.length;
        
        vtrs.forEach(vtr=>{
          if(vtr.empenhos && vtr.empenhos.length > 0){
            activeVtrs++;
            totalEmpenhos += vtr.empenhos.length;
            vtr.empenhos.forEach(emp=>{
              empenhoCounts[emp.j] = (empenhoCounts[emp.j] || 0) + 1;
            });
          }
        });
      });

      const topJ = Object.entries(empenhoCounts).sort((a,b)=>b[1]-a[1])[0];

      const dashboard = document.getElementById('dashboardStats');
      dashboard.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Viaturas Total</div>
          <div class="stat-value">${totalVtrs}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Viaturas Ativas</div>
          <div class="stat-value">${activeVtrs}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Empenhos Total</div>
          <div class="stat-value">${totalEmpenhos}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">J Mais Usado</div>
          <div class="stat-value" style="font-size:24px">${topJ ? topJ[0] : '-'}</div>
        </div>
      `;
    }

    // ====== Alertas de Tempo ======
    function checkTimeAlerts(){
      const now = Date.now();
      session.selectedUnits.forEach(uk=>{
        const vtrs = unitsData[uk]?.vtrs || [];
        vtrs.forEach((vtr,idx)=>{
          if(!vtr.empenhos || vtr.empenhos.length === 0) return;
          
          const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
          const duration = (now - new Date(lastEmpenho.time)) / 60000;
          const threshold = ALERT_THRESHOLDS[lastEmpenho.j];
          
          const alertKey = `${uk}-${idx}-${lastEmpenho.time}`;
          
          if(threshold && duration > threshold && !alertsShown.has(alertKey)){
            alertsShown.add(alertKey);
            showAlert(vtr.id, lastEmpenho.j, Math.floor(duration));
          }
        });
      });
    }

    function showAlert(vtrId, j, mins){
      if(Notification.permission === 'granted'){
        new Notification('âš ï¸ Alerta de Tempo', {
          body: `${vtrId} estÃ¡ em ${j} hÃ¡ ${mins} minutos`,
          icon: 'ğŸš”'
        });
      }
      console.warn(`ALERTA: ${vtrId} em ${j} hÃ¡ ${mins} min`);
    }

    // Solicitar permissÃ£o de notificaÃ§Ã£o
    if('Notification' in window && Notification.permission === 'default'){
      Notification.requestPermission();
Â  Â  }

Â  Â  // FunÃ§Ãµes de Utilidade
Â  Â  function getJText(value){
Â  Â  Â  const empenho = empenhosJ.find(e => e.value === value);
Â  Â  Â  return empenho ? empenho.text : value;
Â  Â  }

Â  Â  function formatTime(date){
Â  Â  Â  return new Date(date).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
Â  Â  }

Â  Â  function timeDifference(start, end = Date.now()){
Â  Â  Â  const diffMs = end - new Date(start);
Â  Â  Â  const diffMins = Math.floor(diffMs / 60000);
Â  Â  Â  const hours = Math.floor(diffMins / 60);
Â  Â  Â  const minutes = diffMins % 60;
Â  Â  Â  return `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
Â  Â  }

Â  Â  // ====== Gerenciamento de VTRs ======

Â  Â  function openVtrModal(unitKey, vtrIndex = null){
Â  Â  Â  const modal = document.getElementById('vtrModal');
Â  Â  Â  const container = document.getElementById('crewInputsContainer');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  editingVtr = {unitKey, vtrIndex};

Â  Â  Â  if(vtrIndex !== null){
Â  Â  Â  Â  const vtr = unitsData[unitKey].vtrs[vtrIndex];
Â  Â  Â  Â  document.getElementById('modalTitle').textContent = `Editar Viatura: ${vtr.id}`;
Â  Â  Â  Â  document.getElementById('modalVtrId').value = vtr.id;
Â  Â  Â  Â  document.getElementById('modalServiceType').value = vtr.service;
Â  Â  Â  Â  document.getElementById('modalVtrPhone').value = vtr.phone || '';
Â  Â  Â  Â  vtr.crew.forEach(member => addCrewInput(member.name, member.rank));
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById('modalTitle').textContent = `Adicionar Viatura em ${units[unitKey]}`;
Â  Â  Â  Â  document.getElementById('modalVtrId').value = '';
Â  Â  Â  Â  document.getElementById('modalServiceType').value = 'ORDINARIO';
Â  Â  Â  Â  document.getElementById('modalVtrPhone').value = '';
Â  Â  Â  Â  for(let i=0; i<3; i++) addCrewInput(); // 3 campos padrÃ£o
Â  Â  Â  }
Â  Â  Â  modal.classList.add('active');
Â  Â  }

Â  Â  function closeVtrModal(){
Â  Â  Â  document.getElementById('vtrModal').classList.remove('active');
Â  Â  Â  editingVtr = null;
Â  Â  }

Â  Â  document.getElementById('addCrewMember').addEventListener('click', () => addCrewInput());

Â  Â  function addCrewInput(name = '', rank = ''){
Â  Â  Â  const container = document.getElementById('crewInputsContainer');
Â  Â  Â  if(container.children.length >= 5) return;
Â  Â  Â Â 
Â  Â  Â  const idx = container.children.length;
Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  div.className = 'crew-input-group';
Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  <div class="crew-input-header">
Â  Â  Â  Â  Â  <h4>Membro ${idx + 1}</h4>
Â  Â  Â  Â  Â  ${idx > 0 ? `<button type="button" class="danger small" onclick="this.closest('.crew-input-group').remove()">Remover</button>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>Posto/GraduaÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  <input type="text" class="crew-rank" value="${rank}" placeholder="Ex: Cap, Sgt, Sd" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="col">
Â  Â  Â  Â  Â  Â  <label>Nome de Guerra</label>
Â  Â  Â  Â  Â  Â  <input type="text" class="crew-name" value="${name}" placeholder="Ex: Silva, Junior" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  container.appendChild(div);
Â  Â  }

Â  Â  document.getElementById('saveVtrBtn').addEventListener('click', saveVtr);

Â  Â  function saveVtr(){
Â  Â  Â  const {unitKey, vtrIndex} = editingVtr;
Â  Â  Â  const id = document.getElementById('modalVtrId').value.trim();
Â  Â  Â  const service = document.getElementById('modalServiceType').value;
Â  Â  Â  const phone = document.getElementById('modalVtrPhone').value.trim();
Â  Â  Â Â 
Â  Â  Â  const crew = Array.from(document.querySelectorAll('#crewInputsContainer .crew-input-group')).map(group => ({
Â  Â  Â  Â  rank: group.querySelector('.crew-rank').value.trim(),
Â  Â  Â  Â  name: group.querySelector('.crew-name').value.trim(),
Â  Â  Â  })).filter(m => m.rank || m.name);

Â  Â  Â  if(!id){
Â  Â  Â  Â  alert('A IdentificaÃ§Ã£o da Viatura Ã© obrigatÃ³ria.');
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const newVtr = {
Â  Â  Â  Â  id, service, crew, phone, unitKey,
Â  Â  Â  Â  empenhos: vtrIndex !== null ? unitsData[unitKey].vtrs[vtrIndex].empenhos : []
Â  Â  Â  };

Â  Â  Â  if(vtrIndex !== null){
Â  Â  Â  Â  unitsData[unitKey].vtrs[vtrIndex] = newVtr;
Â  Â  Â  } else {
Â  Â  Â  Â  // Impedir VTRs com ID duplicado na mesma unidade
Â  Â  Â  Â  if(unitsData[unitKey].vtrs.some(v => v.id === id)){
Â  Â  Â  Â  Â  alert(`A viatura com ID "${id}" jÃ¡ existe na unidade ${units[unitKey]}.`);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  unitsData[unitKey].vtrs.push(newVtr);
Â  Â  Â  }

Â  Â  Â  closeVtrModal();
Â  Â  Â  renderUnits();
Â  Â  Â  updateDashboard();
Â  Â  Â  saveToLocal();
Â  Â  }

Â  Â  function deleteVtr(unitKey, vtrIndex){
Â  Â  Â  if(confirm(`Tem certeza que deseja remover a viatura ${unitsData[unitKey].vtrs[vtrIndex].id}?`)){
Â  Â  Â  Â  unitsData[unitKey].vtrs.splice(vtrIndex, 1);
Â  Â  Â  Â  renderUnits();
Â  Â  Â  Â  updateDashboard();
Â  Â  Â  Â  saveToLocal();
Â  Â  Â  }
Â  Â  }

Â  Â  // ====== Gerenciamento de Empenhos J ======
Â  Â  function openEmpenhoModal(unitKey, vtrIndex){
Â  Â  Â  currentVtrForEmpenho = {unitKey, vtrIndex};
Â  Â  Â  const vtr = unitsData[unitKey].vtrs[vtrIndex];
Â  Â  Â  document.getElementById('modalVtrName').textContent = vtr.id;
Â  Â  Â  document.getElementById('modalEmpenhoJ').value = 'J1'; // PadrÃ£o J1
Â  Â  Â  document.getElementById('modalProtocol').value = '';
Â  Â  Â  document.getElementById('modalActions').value = '';
Â  Â  Â  document.getElementById('empenhoModal').classList.add('active');
Â  Â  }

Â  Â  function closeEmpenhoModal(){
Â  Â  Â  document.getElementById('empenhoModal').classList.remove('active');
Â  Â  Â  currentVtrForEmpenho = null;
Â  Â  }

Â  Â  document.getElementById('saveEmpenhoBtn').addEventListener('click', saveEmpenho);

Â  Â  function saveEmpenho(){
Â  Â  Â  if(!currentVtrForEmpenho) return;
Â  Â  Â  const {unitKey, vtrIndex} = currentVtrForEmpenho;
Â  Â  Â  const vtr = unitsData[unitKey].vtrs[vtrIndex];

Â  Â  Â  const j = document.getElementById('modalEmpenhoJ').value;
Â  Â  Â  const protocol = document.getElementById('modalProtocol').value.trim();
Â  Â  Â  const actions = document.getElementById('modalActions').value.trim();
Â  Â  Â  const now = new Date().toISOString();

Â  Â  Â  const newEmpenho = {
Â  Â  Â  Â  j,
Â  Â  Â  Â  time: now,
Â  Â  Â  Â  protocol: protocol || null,
Â  Â  Â  Â  actions: actions || null
Â  Â  Â  };

Â  Â  Â  vtr.empenhos.push(newEmpenho);
Â  Â  Â  closeEmpenhoModal();
Â  Â  Â  renderUnits();
Â  Â  Â  updateDashboard();
Â  Â  Â  saveToLocal();
Â  Â  }

Â  Â  // ====== RenderizaÃ§Ã£o e Filtro ======
Â  Â  function renderUnits(){
Â  Â  Â  const container = document.getElementById('unitsContainer');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  const search = document.getElementById('searchVtr').value.toLowerCase();
Â  Â  Â  const filterService = document.getElementById('filterService').value;
Â  Â  Â  const filterUnit = document.getElementById('filterUnit').value;

Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  if(filterUnit && filterUnit !== uk) return;

Â  Â  Â  Â  const unitContainer = document.createElement('div');
Â  Â  Â  Â  unitContainer.className = 'unit-card';
Â  Â  Â  Â  unitContainer.innerHTML = `
Â  Â  Â  Â  Â  <div class="unit-header">
Â  Â  Â  Â  Â  Â  <div class="unit-title">
Â  Â  Â  Â  Â  Â  Â  ${units[uk]}
Â  Â  Â  Â  Â  Â  Â  <span class="small" id="vtrCount-${uk}">(${unitsData[uk].vtrs.length} Viaturas)</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="small" onclick="openVtrModal('${uk}', null)">+ Nova VTR</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="vtr-list" id="vtrList-${uk}"></div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  container.appendChild(unitContainer);

Â  Â  Â  Â  const vtrList = document.getElementById(`vtrList-${uk}`);
Â  Â  Â  Â  let unitVtrCount = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  unitsData[uk].vtrs.forEach((vtr, vtrIndex) => {
Â  Â  Â  Â  Â  if(filterService && filterService !== vtr.service) return;
Â  Â  Â  Â  Â  if(search && !vtr.id.toLowerCase().includes(search) && !vtr.crew.some(m => m.name.toLowerCase().includes(search))) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  unitVtrCount++;

Â  Â  Â  Â  Â  const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
Â  Â  Â  Â  Â  const isAlert = lastEmpenho && ALERT_THRESHOLDS[lastEmpenho.j] && (Date.now() - new Date(lastEmpenho.time)) / 60000 > ALERT_THRESHOLDS[lastEmpenho.j];

Â  Â  Â  Â  Â  const vtrItem = document.createElement('div');
Â  Â  Â  Â  Â  vtrItem.className = `vtr-item ${isAlert ? 'alert' : ''}`;
Â  Â  Â  Â  Â  vtrItem.id = `vtr-item-${uk}-${vtrIndex}`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  vtrItem.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="vtr-header">
Â  Â  Â  Â  Â  Â  Â  <span class="vtr-id">
Â  Â  Â  Â  Â  Â  Â  Â  ${vtr.id} ${isAlert ? '<span class="alert-badge">ALERTA</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  <div class="vtr-badges">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="vtr-service">${vtr.service}</span>
Â  Â  Â  Â  Â  Â  Â  Â  ${lastEmpenho ? `<span class="j-counter">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${lastEmpenho.j}</strong> (<span id="vtr-timer-${uk}-${vtrIndex}">0m</span>)
Â  Â  Â  Â  Â  Â  Â  Â  </span>` : ''}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="crew-list">
Â  Â  Â  Â  Â  Â  Â  ${vtr.crew.map(m => `<div class="crew-member"><strong>${m.rank}</strong> ${m.name}</div>`).join('')}
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  ${lastEmpenho ? `
Â  Â  Â  Â  Â  Â  Â  <div class="empenhos-timeline">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="empenho-entry">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="empenho-time empenho-current">${formatTime(lastEmpenho.time)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empenho-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="empenho-label">${getJText(lastEmpenho.j)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${lastEmpenho.protocol ? `<span class="protocol-badge">Prot: ${lastEmpenho.protocol}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${lastEmpenho.actions ? `<div class="empenho-details">${lastEmpenho.actions}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="empenho-duration" id="vtr-duration-${uk}-${vtrIndex}">0m</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ` : `<div class="small" style="margin-top:8px">Sem empenho registrado.</div>`}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="vtr-actions">
Â  Â  Â  Â  Â  Â  Â  <button class="small success" onclick="openEmpenhoModal('${uk}', ${vtrIndex})">Novo J</button>
Â  Â  Â  Â  Â  Â  Â  <button class="small ghost" onclick="openVtrModal('${uk}', ${vtrIndex})">Editar VTR</button>
Â  Â  Â  Â  Â  Â  Â  <button class="small danger" onclick="deleteVtr('${uk}', ${vtrIndex})">Excluir</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  vtrList.appendChild(vtrItem);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById(`vtrCount-${uk}`).textContent = `(${unitVtrCount} Viaturas)`;
Â  Â  Â  Â  // Oculta a unidade se nÃ£o houver viaturas filtradas
Â  Â  Â  Â  if (unitVtrCount === 0 && (filterUnit || search || filterService)) {
Â  Â  Â  Â  Â  unitContainer.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  document.getElementById('searchVtr').addEventListener('input', renderUnits);
Â  Â  document.getElementById('filterService').addEventListener('change', renderUnits);
Â  Â  document.getElementById('filterUnit').addEventListener('change', renderUnits);

Â  Â  // ====== Timers e Alertas ======
Â  Â  function startTimers(){
Â  Â  Â  if(timerInterval) clearInterval(timerInterval);
Â  Â  Â  timerInterval = setInterval(() => {
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  Â  unitsData[uk]?.vtrs.forEach((vtr, vtrIndex) => {
Â  Â  Â  Â  Â  Â  const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
Â  Â  Â  Â  Â  Â  if(lastEmpenho){
Â  Â  Â  Â  Â  Â  Â  const timerElement = document.getElementById(`vtr-timer-${uk}-${vtrIndex}`);
Â  Â  Â  Â  Â  Â  Â  const durationElement = document.getElementById(`vtr-duration-${uk}-${vtrIndex}`);
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  if(timerElement){
Â  Â  Â  Â  Â  Â  Â  Â  const duration = timeDifference(lastEmpenho.time, now);
Â  Â  Â  Â  Â  Â  Â  Â  timerElement.textContent = duration.replace(' ', '');
Â  Â  Â  Â  Â  Â  Â  Â  durationElement.textContent = duration;

Â  Â  Â  Â  Â  Â  Â  Â  const vtrItem = document.getElementById(`vtr-item-${uk}-${vtrIndex}`);
Â  Â  Â  Â  Â  Â  Â  Â  const durationMins = (now - new Date(lastEmpenho.time)) / 60000;
Â  Â  Â  Â  Â  Â  Â  Â  const threshold = ALERT_THRESHOLDS[lastEmpenho.j];

Â  Â  Â  Â  Â  Â  Â  Â  if(threshold && durationMins > threshold){
Â  Â  Â  Â  Â  Â  Â  Â  Â  vtrItem.classList.add('alert');
Â  Â  Â  Â  Â  Â  Â  Â  Â  checkTimeAlerts(); // Verifica se precisa disparar a notificaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  vtrItem.classList.remove('alert');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }, 1000); // Atualiza a cada 1 segundo
Â  Â  }

Â  Â  // ====== PersistÃªncia (Local Storage) ======

Â  Â  function saveToLocal(){
Â  Â  Â  if(!session.id) return;
Â  Â  Â  const sessions = JSON.parse(localStorage.getItem('forceMapSessions') || '[]');
Â  Â  Â  const currentSessionData = {
Â  Â  Â  Â  session,
Â  Â  Â  Â  unitsData,
Â  Â  Â  Â  lastUpdate: new Date().toISOString()
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  const existingIndex = sessions.findIndex(s => s.session.id === session.id);
Â  Â  Â Â 
Â  Â  Â  if(existingIndex > -1){
Â  Â  Â  Â  sessions[existingIndex] = currentSessionData;
Â  Â  Â  } else {
Â  Â  Â  Â  sessions.push(currentSessionData);
Â  Â  Â  }

Â  Â  Â  localStorage.setItem('forceMapSessions', JSON.stringify(sessions));
Â  Â  }

Â  Â  function loadFromLocal(sessionId = null){
Â  Â  Â  const sessions = JSON.parse(localStorage.getItem('forceMapSessions') || '[]');
Â  Â  Â  const dataToLoad = sessionId ? sessions.find(s => s.session.id === sessionId) : null;
Â  Â  Â Â 
Â  Â  Â  if(dataToLoad){
Â  Â  Â  Â  session = dataToLoad.session;
Â  Â  Â  Â  unitsData = dataToLoad.unitsData;

Â  Â  Â  Â  // Atualiza a UI para a tela 2
Â  Â  Â  Â  document.getElementById('operatorName').value = session.operator;
Â  Â  Â  Â  document.getElementById('dateTime').value = session.datetime.slice(0, 16);
Â  Â  Â  Â  document.getElementById('opSummary').textContent = session.operator;
Â  Â  Â  Â  document.getElementById('dtSummary').textContent = new Date(session.datetime).toLocaleString('pt-BR');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const filterUnit = document.getElementById('filterUnit');
Â  Â  Â  Â  filterUnit.innerHTML = '<option value="">Todas as Unidades</option>';
Â  Â  Â  Â  session.selectedUnits.forEach(uk=>{
Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  opt.value = uk;
Â  Â  Â  Â  Â  opt.textContent = units[uk];
Â  Â  Â  Â  Â  filterUnit.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('screen1').style.display = 'none';
Â  Â  Â  Â  document.getElementById('screen2').style.display = 'block';

Â  Â  Â  Â  renderUnits();
Â  Â  Â  Â  updateDashboard();
Â  Â  Â  Â  startTimers();
Â  Â  Â  Â  closeSessionsModal();
Â  Â  Â  Â  alert(`SessÃ£o "${session.operator} - ${new Date(session.datetime).toLocaleString('pt-BR')}" carregada.`);
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  }

Â  Â  document.getElementById('saveLocal').addEventListener('click', () => {
Â  Â  Â  saveToLocal();
Â  Â  Â  alert('SessÃ£o salva localmente!');
Â  Â  });

Â  Â  document.getElementById('finishBtn').addEventListener('click', () => {
Â  Â  Â  if(confirm('Tem certeza que deseja finalizar a sessÃ£o atual? Os dados serÃ£o salvos.')){
Â  Â  Â  Â  saveToLocal();
Â  Â  Â  Â  location.reload(); // Recarrega para a tela 1
Â  Â  Â  }
Â  Â  });

Â  Â  // Tenta carregar a Ãºltima sessÃ£o ao iniciar (se existir)
Â  Â  if(!loadFromLocal(session.id)){
Â  Â  Â  // Se nÃ£o houver sessÃ£o ativa, tenta carregar a mais recente
Â  Â  Â  const sessions = JSON.parse(localStorage.getItem('forceMapSessions') || '[]');
Â  Â  Â  if(sessions.length > 0) {
Â  Â  Â  Â  const latestSession = sessions.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate))[0];
Â  Â  Â  Â  if (confirm(`Deseja carregar a Ãºltima sessÃ£o salva (${latestSession.session.operator} - ${new Date(latestSession.session.datetime).toLocaleString('pt-BR')})?`)) {
Â  Â  Â  Â  Â  loadFromLocal(latestSession.session.id);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }


Â  Â  // ====== MODAL SESSÃ•ES ======
Â  Â  document.getElementById('openSessionsBtn').addEventListener('click', openSessionsModal);

Â  Â  function openSessionsModal(){
Â  Â  Â  const sessions = JSON.parse(localStorage.getItem('forceMapSessions') || '[]');
Â  Â  Â  const list = document.getElementById('sessionsList');
Â  Â  Â  list.innerHTML = '';

Â  Â  Â  if(sessions.length === 0){
Â  Â  Â  Â  list.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Nenhuma sessÃ£o salva localmente.</div>';
Â  Â  Â  }

Â  Â  Â  sessions.sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate)).forEach(s => {
Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  item.className = 'session-item';
Â  Â  Â  Â  item.onclick = () => loadFromLocal(s.session.id);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const vtrCount = Object.values(s.unitsData).reduce((sum, u) => sum + u.vtrs.length, 0);

Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  <div class="session-title">${s.session.operator}</div>
Â  Â  Â  Â  Â  <div class="session-meta">
Â  Â  Â  Â  Â  Â  InÃ­cio: ${new Date(s.session.datetime).toLocaleString('pt-BR')} | 
Â  Â  Â  Â  Â  Â  VTRs: ${vtrCount} | 
Â  Â  Â  Â  Â  Â  Ãšltima AtualizaÃ§Ã£o: ${new Date(s.lastUpdate).toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  document.getElementById('sessionsModal').classList.add('active');
Â  Â  }

Â  Â  function closeSessionsModal(){
Â  Â  Â  document.getElementById('sessionsModal').classList.remove('active');
Â  Â  }


Â  Â  // ====== MODAL ESTATÃSTICAS (Chart.js) ======
Â  Â  document.getElementById('openStatsBtn').addEventListener('click', openStatsModal);

Â  Â  let chartEmpenhosInstance = null;
Â  Â  let chartHorarioInstance = null;

Â  Â  function openStatsModal(){
Â  Â  Â  document.getElementById('statsModal').classList.add('active');
Â  Â  Â  switchTab('charts'); // Inicia na aba de grÃ¡ficos
Â  Â  Â  renderCharts();
Â  Â  Â  renderPerformance();
Â  Â  }

Â  Â  function closeStatsModal(){
Â  Â  Â  document.getElementById('statsModal').classList.remove('active');
Â  Â  Â  if(chartEmpenhosInstance) chartEmpenhosInstance.destroy();
Â  Â  Â  if(chartHorarioInstance) chartHorarioInstance.destroy();
Â  Â  }

Â  Â  function switchTab(tabId){
Â  Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  Â  document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
Â  Â  Â  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
Â  Â  Â  document.getElementById(`tab-${tabId}`).classList.add('active');
Â  Â  Â  if(tabId === 'charts') renderCharts();
Â  Â  }

Â  Â  function renderCharts(){
Â  Â  Â  // Coleta de dados
Â  Â  Â  let empenhoCounts = {};
Â  Â  Â  let hourCounts = new Array(24).fill(0);
Â  Â  Â Â 
Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  unitsData[uk]?.vtrs.forEach(vtr => {
Â  Â  Â  Â  Â  vtr.empenhos.forEach(emp => {
Â  Â  Â  Â  Â  Â  empenhoCounts[emp.j] = (empenhoCounts[emp.j] || 0) + 1;
Â  Â  Â  Â  Â  Â  const hour = new Date(emp.time).getHours();
Â  Â  Â  Â  Â  Â  hourCounts[hour]++;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // GrÃ¡fico de DistribuiÃ§Ã£o de Empenhos
Â  Â  Â  const empenhoLabels = empenhosJ.map(e => e.value);
Â  Â  Â  const empenhoData = empenhoLabels.map(j => empenhoCounts[j] || 0);

Â  Â  Â  const ctxEmpenhos = document.getElementById('chartEmpenhos').getContext('2d');
Â  Â  Â  if(chartEmpenhosInstance) chartEmpenhosInstance.destroy();
Â  Â  Â  chartEmpenhosInstance = new Chart(ctxEmpenhos, {
Â  Â  Â  Â  type: 'pie',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels: empenhoLabels.filter((_, i) => empenhoData[i] > 0),
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  data: empenhoData.filter(d => d > 0),
Â  Â  Â  Â  Â  Â  backgroundColor: ['#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#a78bfa', '#84cc16', '#f97316', '#6366f1', '#ec4899', '#facc15', '#0ea5e9', '#34d399', '#fb7185'],
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  plugins: {legend: {position: 'right', labels: {color: '#e6eef6'}}},
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // GrÃ¡fico de Empenhos por HorÃ¡rio
Â  Â  Â  const hourLabels = Array.from({length:24}, (_, i) => `${i}h`);
Â  Â  Â  const ctxHorario = document.getElementById('chartHorario').getContext('2d');
Â  Â  Â  if(chartHorarioInstance) chartHorarioInstance.destroy();
Â  Â  Â  chartHorarioInstance = new Chart(ctxHorario, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels: hourLabels,
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  label: 'Total de Empenhos',
Â  Â  Â  Â  Â  Â  data: hourCounts,
Â  Â  Â  Â  Â  Â  backgroundColor: '#06b6d4'
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  y: {beginAtZero: true, ticks: {color: '#94a3b8'}},
Â  Â  Â  Â  Â  Â  x: {ticks: {color: '#94a3b8'}}
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  plugins: {legend: {display: false}}
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  function calculateEmpenhoDuration(empenhos){
Â  Â  Â  const durations = {};
Â  Â  Â  for(let i = 0; i < empenhos.length; i++){
Â  Â  Â  Â  const current = empenhos[i];
Â  Â  Â  Â  const next = empenhos[i + 1];
Â  Â  Â  Â  const endTime = next ? new Date(next.time).getTime() : Date.now();
Â  Â  Â  Â  const durationMs = endTime - new Date(current.time).getTime();
Â  Â  Â  Â  const durationMins = Math.floor(durationMs / 60000);

Â  Â  Â  Â  durations[current.j] = (durations[current.j] || 0) + durationMins;
Â  Â  Â  }
Â  Â  Â  return durations;
Â  Â  }

Â  Â  function renderPerformance(){
Â  Â  Â  const container = document.getElementById('performanceStats');
Â  Â  Â  container.innerHTML = '<h3>Tempo Gasto por Viatura em Empenhos J</h3>';

Â  Â  Â  let totalMinutes = 0;
Â  Â  Â  let vtrPerformance = [];

Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  unitsData[uk]?.vtrs.forEach(vtr => {
Â  Â  Â  Â  Â  if(vtr.empenhos.length === 0) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const durations = calculateEmpenhoDuration(vtr.empenhos);
Â  Â  Â  Â  Â  const totalVtrMins = Object.values(durations).reduce((a, b) => a + b, 0);
Â  Â  Â  Â  Â  totalMinutes += totalVtrMins;

Â  Â  Â  Â  Â  vtrPerformance.push({
Â  Â  Â  Â  Â  Â  id: vtr.id,
Â  Â  Â  Â  Â  Â  unit: units[uk],
Â  Â  Â  Â  Â  Â  durations,
Â  Â  Â  Â  Â  Â  totalMins: totalVtrMins
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  if(vtrPerformance.length === 0){
Â  Â  Â  Â  container.innerHTML += '<div style="color:var(--muted);text-align:center;padding:20px">Sem dados de empenho para analisar.</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const totalDurationFormatted = timeDifference(0, totalMinutes * 60000);
Â  Â  Â  container.innerHTML += `<p class="chip" style="margin-bottom:16px;">Total Geral de Tempo Registrado: <strong>${totalDurationFormatted}</strong></p>`;

Â  Â  Â  const table = document.createElement('table');
Â  Â  Â  table.style.width = '100%';
Â  Â  Â  table.style.borderCollapse = 'collapse';
Â  Â  Â  table.innerHTML = `
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr style="background:rgba(255,255,255,0.05);">
Â  Â  Â  Â  Â  Â  <th style="padding:10px;text-align:left;">Viatura (Unidade)</th>
Â  Â  Â  Â  Â  Â  <th style="padding:10px;">J1 (Ativ. Fim)</th>
Â  Â  Â  Â  Â  Â  <th style="padding:10px;">J9/J10 (Ocorr.)</th>
Â  Â  Â  Â  Â  Â  <th style="padding:10px;">J4/J5 (Apoio)</th>
Â  Â  Â  Â  Â  Â  <th style="padding:10px;color:var(--accent);">Tempo Total</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="performanceBody"></tbody>
Â  Â  Â  `;
Â  Â  Â  container.appendChild(table);
Â  Â  Â  const tbody = document.getElementById('performanceBody');

Â  Â  Â  vtrPerformance.sort((a,b) => b.totalMins - a.totalMins).forEach(p => {
Â  Â  Â  Â  const totalJ1 = p.durations.J1 || 0;
Â  Â  Â  Â  const totalOcorr = (p.durations.J9 || 0) + (p.durations.J10 || 0) + (p.durations.J11 || 0);
Â  Â  Â  Â  const totalApoio = (p.durations.J4 || 0) + (p.durations.J5 || 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const row = tbody.insertRow();
Â  Â  Â  Â  row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';

Â  Â  Â  Â  row.insertCell().innerHTML = `<strong>${p.id}</strong> (${p.unit})`;
Â  Â  Â  Â  row.insertCell().textContent = totalJ1 > 0 ? timeDifference(0, totalJ1 * 60000) : '-';
Â  Â  Â  Â  row.insertCell().textContent = totalOcorr > 0 ? timeDifference(0, totalOcorr * 60000) : '-';
Â  Â  Â  Â  row.insertCell().textContent = totalApoio > 0 ? timeDifference(0, totalApoio * 60000) : '-';
Â  Â  Â  Â  row.insertCell().innerHTML = `<strong style="color:var(--accent);">${timeDifference(0, p.totalMins * 60000)}</strong>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Array.from(row.cells).forEach(cell => cell.style.padding = '10px');
Â  Â  Â  Â  Array.from(row.cells).slice(1).forEach(cell => cell.style.textAlign = 'center');
Â  Â  Â  });
Â  Â  }


Â  Â  // ====== EXPORTAÃ‡ÃƒO (PDF / CSV) ======

Â  Â  document.getElementById('exportPdf').addEventListener('click', exportPdf);
Â  Â  document.getElementById('exportCsv').addEventListener('click', exportCsv);

Â  Â  function exportPdf(){
Â  Â  Â  const {jsPDF} = window.jspdf;
Â  Â  Â  const doc = new jsPDF('p', 'mm', 'a4');
Â  Â  Â  let y = 10;
Â  Â  Â  const lineHeight = 5;
Â  Â  Â  const pageHeight = doc.internal.pageSize.height;
Â  Â  Â Â 
Â  Â  Â  doc.setFontSize(16);
Â  Â  Â  doc.text('Mapa da ForÃ§a - RelatÃ³rio de Controle', 10, y);
Â  Â  Â  y += lineHeight * 2;
Â  Â  Â Â 
Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  doc.text(`Operador: ${session.operator}`, 10, y); y += lineHeight;
Â  Â  Â  doc.text(`InÃ­cio da SessÃ£o: ${new Date(session.datetime).toLocaleString('pt-BR')}`, 10, y); y += lineHeight * 2;

Â  Â  Â  doc.setFontSize(12);
Â  Â  Â Â 
Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  const unitVtrs = unitsData[uk]?.vtrs || [];
Â  Â  Â  Â  if(unitVtrs.length === 0) return;

Â  Â  Â  Â  if(y > pageHeight - 30){ doc.addPage(); y = 10; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  doc.setFontSize(14);
Â  Â  Â  Â  doc.text(`Unidade: ${units[uk]}`, 10, y); y += lineHeight * 1.5;
Â  Â  Â  Â  doc.setFontSize(10);

Â  Â  Â  Â  unitVtrs.forEach(vtr => {
Â  Â  Â  Â  Â  if(y > pageHeight - 30){ doc.addPage(); y = 10; }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  doc.text(`Viatura: ${vtr.id} (ServiÃ§o: ${vtr.service}) - Tel: ${vtr.phone || '-'}`, 15, y, {fontStyle: 'bold'}); y += lineHeight;

Â  Â  Â  Â  Â  doc.text(`TripulaÃ§Ã£o: ${vtr.crew.map(m => `${m.rank} ${m.name}`).join(', ')}`, 15, y); y += lineHeight;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  doc.text('HistÃ³rico de Empenhos:', 15, y); y += lineHeight;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  vtr.empenhos.forEach(emp => {
Â  Â  Â  Â  Â  Â  if(y > pageHeight - 30){ doc.addPage(); y = 10; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const time = new Date(emp.time).toLocaleString('pt-BR');
Â  Â  Â  Â  Â  Â  const description = `${getJText(emp.j)} (Prot: ${emp.protocol || '-'})`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  doc.text(`- ${time}: ${description}`, 20, y); y += lineHeight;
Â  Â  Â  Â  Â  Â  if(emp.actions){
Â  Â  Â  Â  Â  Â  Â  const actionsLines = doc.splitTextToSize(`AÃ§Ãµes: ${emp.actions}`, 170);
Â  Â  Â  Â  Â  Â  Â  doc.text(actionsLines, 25, y);
Â  Â  Â  Â  Â  Â  Â  y += actionsLines.length * lineHeight;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  y += lineHeight; // EspaÃ§o apÃ³s a viatura
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  doc.save(`Relatorio_Mapa_Forca_${session.operator}_${new Date().toISOString().slice(0, 10)}.pdf`);
Â  Â  }

Â  Â  function exportCsv(){
Â  Â  Â  let csv = 'Unidade;Viatura;ServiÃ§o;Posto/GraduaÃ§Ã£o;Nome de Guerra;Telefone;Tipo de Empenho;HorÃ¡rio;Protocolo;AÃ§Ãµes\n';

Â  Â  Â  session.selectedUnits.forEach(uk => {
Â  Â  Â  Â  unitsData[uk]?.vtrs.forEach(vtr => {
Â  Â  Â  Â  Â  const baseRow = `${units[uk]};${vtr.id};${vtr.service};;;${vtr.phone || '-'};;;;`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Adiciona a tripulaÃ§Ã£o
Â  Â  Â  Â  Â  vtr.crew.forEach(member => {
Â  Â  Â  Â  Â  Â  csv += `${units[uk]};${vtr.id};${vtr.service};${member.rank};${member.name};${vtr.phone || '-'};;;;\n`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Adiciona os empenhos
Â  Â  Â  Â  Â  vtr.empenhos.forEach(emp => {
Â  Â  Â  Â  Â  Â  const time = new Date(emp.time).toLocaleString('pt-BR');
Â  Â  Â  Â  Â  Â  const actions = (emp.actions || '').replace(/"/g, '""');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  csv += `${units[uk]};${vtr.id};${vtr.service};;;${vtr.phone || '-'};"${getJText(emp.j)}";${time};${emp.protocol || '-'};"${actions}"\n`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  link.download = `Relatorio_Mapa_Forca_${session.operator}_${new Date().toISOString().slice(0, 10)}.csv`;
Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  link.click();
Â  Â  Â  document.body.removeChild(link);
Â  Â  }

Â  </script>
</body>
</html>
