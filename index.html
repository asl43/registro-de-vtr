<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mapa da For√ßa ‚Äî Controle de Unidades</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.04);--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
        *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,Helvetica,Arial}
        body{margin:0;background:linear-gradient(180deg,#06202a 0%,#071425 100%);color:#e6eef6;min-height:100vh;padding:24px}
        .app{width:100%;max-width:1400px;margin:0 auto}
        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:12px}
        h1{font-size:20px;margin:0}
        h2{font-size:18px;margin:12px 0 8px}
        h3{font-size:15px;margin:8px 0;color:var(--accent)}
        .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.6);margin-bottom:14px}
        
        label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
        input[type=text],input[type=datetime-local],select,input[type=tel],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
        textarea{resize:vertical;min-height:80px}
        
        .row{display:flex;gap:12px;margin-bottom:12px}
        .col{flex:1}
        .col-auto{flex:0 0 auto}
        
        button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#022;cursor:pointer;font-weight:600;font-size:13px;transition:opacity 0.2s}
        button:hover{opacity:0.9}
        button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
        button.danger{background:var(--danger);color:white}
        button.success{background:var(--success);color:white}
        button.small{padding:6px 10px;font-size:12px}
        
        .multi-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;max-height:300px;overflow-y:auto;padding:12px;background:var(--glass);border-radius:8px}
        .unit-checkbox{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;cursor:pointer;transition:background 0.2s}
        .unit-checkbox:hover{background:rgba(255,255,255,0.02)}
        .unit-checkbox input{cursor:pointer}
        .unit-checkbox label{cursor:pointer;margin:0;color:#e6eef6}
        
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
        .stat-card{background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:10px;padding:16px;text-align:center}
        .stat-value{font-size:32px;font-weight:700;color:var(--accent);margin:8px 0}
        .stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
        
        .alert-badge{background:var(--danger);color:white;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-left:8px;animation:pulse 2s infinite}
        
        .search-filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
        .search-box{flex:1;min-width:200px}
        
        .units-grid{display:grid;gap:14px}
        .unit-card{background:rgba(6,182,212,0.05);border:1px solid rgba(6,182,212,0.2);border-radius:10px;padding:14px}
        .unit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .unit-title{font-weight:600;font-size:16px;color:var(--accent)}
        
        .vtr-list{margin-top:12px}
        /* ESTILO COMPACTO PARA VTR */
        .vtr-item{
            background:var(--glass);border:1px solid rgba(255,255,255,0.06);border-radius:8px;
            padding:10px;margin-bottom:8px;transition:all 0.3s;
            display:flex;align-items:center;justify-content:space-between;gap:8px;
            flex-wrap:wrap;
        }
        .vtr-item.alert{border-color:var(--danger);box-shadow:0 0 10px rgba(239,68,68,0.3)}
        .vtr-item.hidden{display:none}

        .vtr-info{display:flex;align-items:center;gap:10px;flex:1 1 200px;}
        .vtr-id{font-weight:600;color:#e6eef6;font-size:14px}
        .vtr-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .vtr-service{display:inline-block;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;background:rgba(16,185,129,0.2);color:var(--success)}
        .j-counter{display:inline-flex;gap:4px;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;background:rgba(245,158,11,0.2);color:var(--warning)}
        .vtr-duration{font-weight:600;font-size:12px;min-width:60px;text-align:right;color:var(--warning)}
        
        .vtr-actions{display:flex;gap:6px;flex-wrap:wrap}
        /* FIM ESTILO COMPACTO */
        
        .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:12px;display:inline-block}
        .small{font-size:12px;color:var(--muted)}
        
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
        
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
        .modal.active{display:flex}
        .modal-content{background:var(--card);border-radius:12px;padding:24px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;margin:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{background:transparent;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px}
        
        .crew-input-group{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.05)}
        .crew-input-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .crew-input-header h4{margin:0;font-size:13px;color:var(--accent)}
        
        .chart-container{background:var(--glass);border-radius:8px;padding:16px;margin-bottom:16px}
        canvas{max-height:300px}
        
        .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .tab{padding:10px 16px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:14px;font-weight:600;border-bottom:2px solid transparent;transition:all 0.2s}
        .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        
        .occurrence-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--warning);
        }
        .occurrence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .occurrence-vtr {
            font-weight: 700;
            color: var(--accent);
            font-size: 15px;
        }
        .occurrence-j {
            font-weight: 600;
            color: var(--warning);
            font-size: 13px;
        }
        .occurrence-protocol {
            background: var(--glass);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #a78bfa;
            font-weight: 600;
        }
        .occurrence-actions {
            font-size: 13px;
            color: #e6eef6;
            white-space: pre-wrap; 
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        /* Estilos espec√≠ficos para o novo modal de busca */
        #quickSearchVtr {
            width: 100%;
            margin-bottom: 15px;
        }
        #quickSearchResult {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            min-height: 50px;
            color: var(--muted);
            text-align: center;
        }
        .found-vtr {
            background: rgba(6, 182, 212, 0.1);
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            color: var(--accent);
            text-align: left;
            margin-bottom: 10px;
        }
        .vtr-warning {
            color: var(--danger);
            font-weight: 600;
            margin-top: 10px;
        }

        /* Estilo para o modal de adicionar unidades */
        #unitsToAddContainer {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
        }

        /* Estilo para a tabela de desempenho */
        .performance-table th, .performance-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .performance-table th {
            background: rgba(255,255,255,0.05);
        }
        .performance-table tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        /* Estilos para o modal de detalhes da VTR */
        .empenho-history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }
        .empenho-history-item strong {
            color: var(--warning);
        }
        .empenho-history-item .small {
            color: var(--muted);
        }
        .empenho-history-item pre {
            white-space: pre-wrap;
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            overflow-x: auto;
        }
        
        @media (max-width:700px){.row{flex-direction:column}.dashboard-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>üöî Mapa da For√ßa ‚Äî Controle de Unidades</h1>
            <div style="display:flex;gap:8px">
                <button id="openQuickEmpenhoBtn" class="success small">‚ö° Empenho R√°pido</button>
                <button id="openStatsBtn" class="ghost small">üìä Estat√≠sticas</button>
            </div>
        </header>

        <section class="card" id="screen1">
            <h2>Passo 1 ‚Äî Informa√ß√µes da Opera√ß√£o</h2>
            <div class="row">
                <div class="col">
                    <label>Nome do Operador *</label>
                    <input id="operatorName" type="text" placeholder="Seu nome completo" required />
                </div>
                <div class="col">
                    <label>Data e Hora de In√≠cio *</label>
                    <input id="dateTime" type="datetime-local" required />
                </div>
            </div>

            <div style="margin-top:16px">
                <label>Selecione as Unidades para Controlar *</label>
                <div class="multi-select" id="unitsMultiSelect"></div>
            </div>

            <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
                <div class="small">Selecione pelo menos uma unidade</div>
                <button id="toStep2">Iniciar Controle ‚Üí</button>
            </div>
        </section>

        <section id="screen2" style="display:none">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                    <div>
                        <div class="chip">üë§ <strong id="opSummary"></strong></div>
                        <div class="chip" style="margin-left:8px">üìÖ <strong id="dtSummary"></strong></div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button id="openAddUnitBtn" class="ghost small" onclick="openAddUnitModal()">+ Unidade</button> 
                        <button id="exportPdf" class="ghost small">üìÑ PDF</button>
                        <button id="exportCsv" class="ghost small">üìä CSV</button>
                        <button id="saveLocal" class="success small">üíæ Salvar</button>
                        <button id="finishBtn" class="danger small">Finalizar</button>
                    </div>
                </div>

                <div class="dashboard-grid" id="dashboardStats"></div>
            </div>

            <div class="card">
                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchVtr" placeholder="üîç Buscar viatura por ID ou tripulante..." />
                    </div>
                    <select id="filterService">
                        <option value="">Todos os Servi√ßos</option>
                        <option value="ORDINARIO">ORDIN√ÅRIO</option>
                        <option value="SEG">SEG</option>
                        <option value="POG">POG</option>
                        <option value="OPERA√á√ÉO">OPERA√á√ÉO</option>
                    </select>
                    <select id="filterUnit">
                        <option value="">Todas as Unidades</option>
                    </select>
                </div>
            </div>

            <div class="units-grid" id="unitsContainer"></div>
        </section>

        <div class="modal" id="addUnitModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Adicionar Unidades ao Controle</div>
                    <button class="modal-close" onclick="closeAddUnitModal()">√ó</button>
                </div>
                
                <p class="small">Selecione as unidades que deseja incluir na sua sess√£o de controle.</p>

                <div class="multi-select" id="unitsToAddContainer">
                    </div>

                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeAddUnitModal()">Cancelar</button>
                    <button id="addUnitsBtn" class="success" onclick="addSelectedUnits()">Adicionar Unidades</button>
                </div>
            </div>
        </div>

        <div class="modal" id="vtrModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Adicionar Viatura</div>
                    <button class="modal-close" onclick="closeVtrModal()">√ó</button>
                </div>
                <div>
                    <label>Identifica√ß√£o da Viatura *</label>
                    <input id="modalVtrId" type="text" placeholder="Ex: VTR-001, Guarni√ß√£o 01" />
                </div>

                <div style="margin-top:12px">
                    <label>Tipo de Servi√ßo *</label>
                    <select id="modalServiceType">
                        <option value="ORDINARIO">ORDIN√ÅRIO</option>
                        <option value="SEG">SEG</option>
                        <option value="POG">POG</option>
                        <option value="OPERA√á√ÉO">OPERA√á√ÉO</option>
                    </select>
                </div>

                <div style="margin-top:16px">
                    <h3 style="margin-bottom:12px">Equipe da Viatura (at√© 5 membros)</h3>
                    <div id="crewInputsContainer"></div>
                    <button id="addCrewMember" class="ghost small" style="margin-top:8px">+ Adicionar Membro</button>
                </div>

                <div style="margin-top:12px">
                    <label>Telefone de Contato</label>
                    <input id="modalVtrPhone" type="tel" placeholder="(92) 9xxxx-xxxx" />
                </div>

                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeVtrModal()">Cancelar</button>
                    <button id="saveVtrBtn" class="success">Salvar Viatura</button>
                </div>
            </div>
        </div>

        <div class="modal" id="empenhoModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Registrar Empenho J</div>
                    <button class="modal-close" onclick="closeEmpenhoModal()">√ó</button>
                </div>
                
                <div class="small" style="margin-bottom:12px;background:rgba(6,182,212,0.1);padding:8px;border-radius:6px">
                    Viatura: <strong id="modalVtrName"></strong>
                </div>

                <div>
                    <label>Empenho J *</label>
                    <select id="modalEmpenhoJ"></select>
                </div>

                <div style="margin-top:12px">
                    <label>N√∫mero de Protocolo</label>
                    <input id="modalProtocol" type="text" placeholder="Ex: 2024-12345" />
                </div>

                <div style="margin-top:12px">
                    <label>A√ß√µes Empregadas</label>
                    <textarea id="modalActions" placeholder="Descreva as a√ß√µes realizadas..."></textarea>
                </div>

                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeEmpenhoModal()">Cancelar</button>
                    <button id="saveEmpenhoBtn" class="success">Registrar Empenho</button>
                </div>
            </div>
        </div>

        <div class="modal" id="quickEmpenhoModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‚ö° Empenho R√°pido por Viatura</div>
                    <button class="modal-close" onclick="closeQuickEmpenhoModal()">√ó</button>
                </div>
                
                <div>
                    <label>Buscar Identifica√ß√£o da Viatura (Ex: VTR-001)</label>
                    <input id="quickSearchVtr" type="text" placeholder="Digite a ID da VTR" />
                </div>

                <div id="quickSearchResult" style="margin-bottom:15px;">
                    Nenhuma viatura selecionada.
                </div>

                <div id="quickEmpenhoForm" style="display:none;">
                    <div style="margin-bottom:12px;">
                        <label>Empenho J *</label>
                        <select id="quickModalEmpenhoJ"></select>
                    </div>

                    <div style="margin-top:12px">
                        <label>N√∫mero de Protocolo</label>
                        <input id="quickModalProtocol" type="text" placeholder="Ex: 2024-12345" />
                    </div>

                    <div style="margin-top:12px">
                        <label>A√ß√µes Empregadas</label>
                        <textarea id="quickModalActions" placeholder="Descreva as a√ß√µes realizadas..."></textarea>
                    </div>

                    <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                        <button class="ghost" onclick="closeQuickEmpenhoModal()">Cancelar</button>
                        <button id="saveQuickEmpenhoBtn" class="success">Registrar Empenho</button>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="modal" id="detailsModal">
            <div class="modal-content" style="max-width:800px">
                <div class="modal-header">
                    <div class="modal-title" id="detailsModalTitle">Detalhes das Viaturas</div>
                    <button class="modal-close" onclick="closeDetailsModal()">√ó</button>
                </div>
                <div id="detailsModalContent" style="max-height:60vh; overflow-y:auto;">
                    </div>
            </div>
        </div>
        
        <div class="modal" id="statsModal">
            <div class="modal-content" style="max-width:900px">
                <div class="modal-header">
                    <div class="modal-title">üìä Estat√≠sticas e An√°lises</div>
                    <button class="modal-close" onclick="closeStatsModal()">√ó</button>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('charts')">üìà Gr√°ficos</button>
                    <button class="tab" onclick="switchTab('performance')">‚è±Ô∏è Desempenho</button>
                    <button class="tab" onclick="switchTab('occurrences')">üö® Ocorr√™ncias</button>
                </div>

                <div class="tab-content active" id="tab-charts">
                    <div class="chart-container">
                        <h3>Distribui√ß√£o de Empenhos por Tipo (J)</h3>
                        <canvas id="chartEmpenhos"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Frequ√™ncia de Empenhos por Hor√°rio</h3>
                        <canvas id="chartHorario"></canvas>
                    </div>
                </div>

                <div class="tab-content" id="tab-performance">
                    <div id="performanceStats"></div>
                </div>
                
                <div class="tab-content" id="tab-occurrences">
                    <div class="search-box" style="margin-bottom:15px;">
                        <input type="text" id="searchProtocol" placeholder="üîç Buscar por n√∫mero de Protocolo..." oninput="generateOcurrenceList()" />
                    </div>
                    <h3 style="margin-bottom:16px;">Registros de Ocorr√™ncias com A√ß√µes e Protocolos</h3>
                    <div id="occurrenceList"></div>
                </div>
            </div>
        </div>

        <div class="modal" id="vtrDetailsModal">
            <div class="modal-content" style="max-width:800px">
                <div class="modal-header">
                    <div class="modal-title" id="vtrDetailsModalTitle">Detalhes da Viatura</div>
                    <button class="modal-close" onclick="closeVtrDetailsModal()">√ó</button>
                </div>
                <div id="vtrDetailsModalContent">
                    </div>
            </div>
        </div>

    </div>

    <script>
        const units = {
            '25DIP': '25 CICOM','11DIP': '11 CICOM','28DIP': '28 CICOM','29DIP': '29 CICOM',
            '01DIP': '1 CICOM','02DIP': '2 CICOM','03DIP': '3 CICOM','04DIP': '4 CICOM',
            '05DIP': '5 CICOM','06DIP': '6 CICOM','07DIP': '7 CICOM','08DIP': '8 CICOM',
            '09DIP': '9 CICOM','10DIP': '10 CICOM','12DIP': '12 CICOM','13DIP': '13 CICOM',
            '14DIP': '14 CICOM','15DIP': '15 CICOM','16DIP': '16 CICOM','17DIP': '17 CICOM',
            '18DIP': '18 CICOM','19DIP': '19 CICOM','20DIP': '20 CICOM','21DIP': '21 CICOM',
            '22DIP': '22 CICOM','23DIP': '23 CICOM','24DIP': '24 CICOM','26DIP': '26 CICOM',
            '27DIP': '27 CICOM','30DIP': '30 CICOM',
            'CPA NORTE': 'CPA NORTE','CPA SUL': 'CPA SUL','CPA LESTE': 'CPA LESTE','CPA OESTE': 'CPA OESTE',
            'CPA C. SUL/C. OESTE': 'CPA C. SUL/C. OESTE',
            'FT': 'FT','BPTRAN': 'BPTRAN','CPTUR': 'CPTUR','RMP': 'RMP','CICLO': 'CICLO',
            'ROCAM': 'ROCAM','CHOQUE': 'CHOQUE','MARTE': 'MARTE','RPMON': 'RPMON','CIPC√ÉES': 'CIPC√ÉES',
            'COE': 'COE','BPAMB': 'BPAMB','CECOPOM': 'CECOPOM','GRAER': 'GRAER','BPG': 'BPG','NPPM': 'NPPM'
        };

        const empenhosJ = [
            {value:'J1',text:'J1: Atividade Fim'},{value:'J2',text:'J2: Atividade administrativa'},
            {value:'J3',text:'J3: Substitui√ß√£o de Guarni√ß√£o PM'},{value:'J4',text:'J4: Refei√ß√£o'},
            {value:'J5',text:'J5: Abastecimento'},{value:'J6',text:'J6: Limpeza de viatura'},
            {value:'J7',text:'J7: Manuten√ß√£o mec√¢nica'},{value:'J8',text:'J8: Necessidades Fisiol√≥gicas'},
            {value:'J9',text:'J9: Deslocamento para ocorr√™ncia'},{value:'J10',text:'J10: Chegada no local da ocorr√™ncia'},
            {value:'J11',text:'J11: Sa√≠da do local da ocorr√™ncia'},{value:'J12',text:'J12: Guarni√ß√£o na base'},
            {value:'J15',text:'J15: Opera√ß√£o Policial Militar'}
        ];

        const ALERT_THRESHOLDS = {J10:30,J9:20,J1:60};

        let session = {operator:'',datetime:'',selectedUnits:[],id:null};
        let unitsData = {};
        let editingVtr = null;
        let currentVtrForEmpenho = null; // Usado pelo modal de empenho padr√£o
        let quickEmpenhoVtr = null; // Usado pelo modal de empenho r√°pido
        let timerInterval = null;
        let alertsShown = new Set();
        let empenhosChart = null; 
        let horarioChart = null;  

        // ====== Inicializa√ß√£o ======
        (function init(){
            const multiSelect = document.getElementById('unitsMultiSelect');
            Object.entries(units).forEach(([k,v])=>{
                const div = document.createElement('div');
                div.className = 'unit-checkbox';
                div.innerHTML = `<input type="checkbox" id="unit_${k}" value="${k}"><label for="unit_${k}">${v}</label>`;
                multiSelect.appendChild(div);
            });

            const modalEmpenhoJ = document.getElementById('modalEmpenhoJ');
            const quickModalEmpenhoJ = document.getElementById('quickModalEmpenhoJ');
            empenhosJ.forEach(e=>{
                const opt = document.createElement('option');
                opt.value = e.value;
                opt.textContent = e.text;
                modalEmpenhoJ.appendChild(opt.cloneNode(true));
                quickModalEmpenhoJ.appendChild(opt);
            });

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTime').value = now.toISOString().slice(0,16);
            
            loadFromLocal();

            // Adiciona listener para a busca r√°pida
            document.getElementById('quickSearchVtr').addEventListener('input', findVtrForQuickEmpenho);
        })();

        // ====== Fun√ß√µes de Utilidade ======
        function getJText(value){
            const empenho = empenhosJ.find(e => e.value === value);
            return empenho ? empenho.text : value;
        }

        function formatTime(date){
            return new Date(date).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        }

        function timeDifference(start, end = Date.now()){
            const diffMs = end - new Date(start);
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            return `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
        }
        
        // Retorna a VTR e seus √≠ndices
        function findVtrById(id) {
            for (const unitKey in unitsData) {
                const vtrs = unitsData[unitKey].vtrs;
                const vtrIndex = vtrs.findIndex(v => v.id.toLowerCase() === id.toLowerCase());
                if (vtrIndex !== -1) {
                    return { unitKey, vtrIndex, vtr: vtrs[vtrIndex] };
                }
            }
            return null;
        }

        // ====== Persist√™ncia (Salvar/Carregar) ======
        function saveToLocal() {
            if (session.id) {
                const sessionToSave = {
                    session: session,
                    unitsData: unitsData
                };
                localStorage.setItem('currentSession', JSON.stringify(sessionToSave));
            }
        }

        function loadFilterUnits() {
            const filterUnit = document.getElementById('filterUnit');
            filterUnit.innerHTML = '<option value="">Todas as Unidades</option>';
            session.selectedUnits.forEach(uk=>{
                const opt = document.createElement('option');
                opt.value = uk;
                opt.textContent = units[uk];
                filterUnit.appendChild(opt);
            });
        }

        function loadFromLocal() {
            const savedSession = localStorage.getItem('currentSession');
            if (savedSession) {
                const data = JSON.parse(savedSession);
                session = data.session;
                unitsData = data.unitsData;

                document.getElementById('operatorName').value = session.operator;
                document.getElementById('dateTime').value = session.datetime.slice(0,16);
                // Marca as unidades na tela 1, caso o usu√°rio volte
                session.selectedUnits.forEach(uk => {
                    const cb = document.getElementById(`unit_${uk}`);
                    if (cb) cb.checked = true;
                });

                if (session.operator && session.datetime && session.selectedUnits.length > 0) {
                    document.getElementById('opSummary').textContent = session.operator;
                    document.getElementById('dtSummary').textContent = new Date(session.datetime).toLocaleString('pt-BR');
                    
                    loadFilterUnits(); // Carrega o filtro com as unidades salvas

                    document.getElementById('screen1').style.display = 'none';
                    document.getElementById('screen2').style.display = 'block';

                    renderUnits();
                    updateDashboard();
                    startTimers();
                }
            }
        }
        
        document.getElementById('saveLocal').addEventListener('click', () => {
             saveToLocal();
             alert('Sess√£o salva localmente com sucesso!');
        });


        // ====== Passo 1 ‚Üí Passo 2 ======
        document.getElementById('toStep2').addEventListener('click', ()=>{
            const op = document.getElementById('operatorName').value.trim();
            const dt = document.getElementById('dateTime').value;
            const selected = Array.from(document.querySelectorAll('#unitsMultiSelect input:checked')).map(cb=>cb.value);

            if(!op || !dt){
                alert('Preencha o nome do operador e a data/hora.');
                return;
            }
            if(selected.length === 0){
                alert('Selecione pelo menos uma unidade para controlar.');
                return;
            }

            session.operator = op;
            session.datetime = dt;
            session.selectedUnits = selected;
            session.id = Date.now(); 

            selected.forEach(uk=>{
                if(!unitsData[uk]) unitsData[uk] = {vtrs:[]};
            });

            document.getElementById('opSummary').textContent = op;
            document.getElementById('dtSummary').textContent = new Date(dt).toLocaleString('pt-BR');

            loadFilterUnits(); // Carrega o filtro

            document.getElementById('screen1').style.display = 'none';
            document.getElementById('screen2').style.display = 'block';

            renderUnits();
            updateDashboard();
            startTimers();
            saveToLocal();
        });
        
        // ====== Funcionalidade de Adicionar Unidades (Mantido) ======
        function openAddUnitModal() {
            const modal = document.getElementById('addUnitModal');
            const container = document.getElementById('unitsToAddContainer');
            container.innerHTML = '';
            
            const unitsNotSelected = Object.keys(units).filter(k => !session.selectedUnits.includes(k));

            if (unitsNotSelected.length === 0) {
                container.innerHTML = '<p class="small" style="text-align:center;padding:10px;">Todas as unidades est√£o ativas.</p>';
                document.getElementById('addUnitsBtn').disabled = true;
            } else {
                document.getElementById('addUnitsBtn').disabled = false;
                unitsNotSelected.forEach(k => {
                    const v = units[k];
                    const div = document.createElement('div');
                    div.className = 'unit-checkbox';
                    div.innerHTML = `<input type="checkbox" id="add_unit_${k}" value="${k}"><label for="add_unit_${k}">${v}</label>`;
                    container.appendChild(div);
                });
            }

            modal.classList.add('active');
        }

        function closeAddUnitModal() {
            document.getElementById('addUnitModal').classList.remove('active');
        }

        function addSelectedUnits() {
            const selected = Array.from(document.querySelectorAll('#unitsToAddContainer input:checked')).map(cb => cb.value);

            if (selected.length === 0) {
                alert('Selecione pelo menos uma unidade para adicionar.');
                return;
            }

            selected.forEach(uk => {
                if (!session.selectedUnits.includes(uk)) {
                    session.selectedUnits.push(uk);
                    unitsData[uk] = { vtrs: [] };
                }
            });

            closeAddUnitModal();
            loadFilterUnits(); // Atualiza o filtro de unidades
            renderUnits(); // Re-renderiza a tela
            updateDashboard(); // Atualiza estat√≠sticas
            saveToLocal();
            alert(`${selected.length} unidade(s) adicionada(s) com sucesso!`);
        }

        // ====== Fun√ß√£o para Finalizar Sess√£o (Mantido) ======
        document.getElementById('finishBtn').addEventListener('click', finishSession);

        function finishSession() {
            if (!confirm('Deseja realmente finalizar o turno atual? Todos os dados em tempo real ser√£o zerados (mas permanecer√£o no hist√≥rico se salvos).')) {
                return;
            }

            clearInterval(timerInterval); 

            session = {operator:'',datetime:'',selectedUnits:[],id:null};
            unitsData = {};
            alertsShown = new Set();
            
            localStorage.removeItem('currentSession');

            document.getElementById('screen2').style.display = 'none';
            document.getElementById('screen1').style.display = 'block';

            document.getElementById('operatorName').value = '';
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTime').value = now.toISOString().slice(0,16);
            
            Array.from(document.querySelectorAll('#unitsMultiSelect input:checked')).forEach(cb => cb.checked = false);


            alert('Turno finalizado com sucesso! Pronto para iniciar um novo Mapa da For√ßa.');
        }

        // ====== Dashboard, Alertas e Timers (Mantidos) ======
        function updateDashboard(){
            let totalVtrs = 0;
            let totalEmpenhos = 0;
            let empenhoCounts = {};
            let activeVtrs = 0;

            session.selectedUnits.forEach(uk=>{
                const vtrs = unitsData[uk]?.vtrs || [];
                totalVtrs += vtrs.length;
                
                vtrs.forEach(vtr=>{
                    if(vtr.empenhos && vtr.empenhos.length > 0){
                        activeVtrs++;
                        totalEmpenhos += vtr.empenhos.length;
                        const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                        empenhoCounts[lastEmpenho.j] = (empenhoCounts[lastEmpenho.j] || 0) + 1;
                    }
                });
            });

            const topJ = Object.entries(empenhoCounts).sort((a,b)=>b[1]-a[1])[0];

            const dashboard = document.getElementById('dashboardStats');
            dashboard.innerHTML = `
                <div class="stat-card" style="cursor:pointer;" onclick="openDetailsModal('total')">
                    <div class="stat-label">Viaturas Total</div>
                    <div class="stat-value">${totalVtrs}</div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="openDetailsModal('active')">
                    <div class="stat-label">Viaturas Ativas</div>
                    <div class="stat-value">${activeVtrs}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Empenhos Total</div>
                    <div class="stat-value">${totalEmpenhos}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">J Mais Usado</div>
                    <div class="stat-value" style="font-size:24px">${topJ ? topJ[0] : '-'}</div>
                </div>
            `;
        }
        
        function openDetailsModal(type) {
            const modal = document.getElementById('detailsModal');
            const title = document.getElementById('detailsModalTitle');
            const content = document.getElementById('detailsModalContent');
            content.innerHTML = '';

            title.textContent = type === 'total' ? 'Detalhes: Todas as Viaturas' : 'Detalhes: Viaturas Ativas';

            let allVtrs = [];
            session.selectedUnits.forEach(uk => {
                const unitName = units[uk];
                const vtrs = unitsData[uk]?.vtrs || [];

                vtrs.forEach(vtr => {
                    const lastEmpenho = vtr.empenhos.length > 0 ? vtr.empenhos[vtr.empenhos.length - 1] : null;

                    if (type === 'total' || (type === 'active' && lastEmpenho)) {
                        allVtrs.push({
                            id: vtr.id,
                            unit: unitName,
                            lastEmpenho: lastEmpenho
                        });
                    }
                });
            });

            if (allVtrs.length === 0) {
                content.innerHTML = '<p class="small" style="text-align:center;padding:20px;">Nenhuma viatura encontrada para este filtro.</p>';
                modal.classList.add('active');
                return;
            }

            allVtrs.forEach(vtr => {
                const item = document.createElement('div');
                const isAlert = vtr.lastEmpenho && ALERT_THRESHOLDS[vtr.lastEmpenho.j] && (Date.now() - new Date(vtr.lastEmpenho.time)) / 60000 > ALERT_THRESHOLDS[vtr.lastEmpenho.j];
                item.className = 'vtr-item' + (isAlert ? ' alert' : '');
                
                let statusHtml = '<div class="j-counter" style="background:rgba(255,255,255,0.1);color:var(--muted)">Sem Empenho J</div>';
                let service = vtr.lastEmpenho ? vtr.lastEmpenho.j : 'N/A';
                
                if (vtr.lastEmpenho) {
                    const duration = timeDifference(vtr.lastEmpenho.time);
                    const currentClass = isAlert ? 'alert-badge' : 'empenho-current';
                    
                    statusHtml = `
                        <div class="vtr-badges">
                            <span class="vtr-service">${service}</span>
                            <span class="j-counter ${currentClass}">${duration}</span>
                        </div>
                    `;
                }

                item.innerHTML = `
                    <div class="vtr-info">
                        <div class="vtr-id">
                            ${vtr.id}
                            ${isAlert ? '<span class="alert-badge">ALERTA TEMPO!</span>' : ''}
                        </div>
                        ${statusHtml}
                    </div>
                    <div class="small">
                        Unidade: **${vtr.unit}** | Servi√ßo: ${vtr.lastEmpenho ? getJText(vtr.lastEmpenho.j) : 'VTR em Base/Sem J Ativo'}
                    </div>
                    ${vtr.lastEmpenho ? `<div class="small" style="margin-top:4px;">In√≠cio: ${formatTime(vtr.lastEmpenho.time)} ${vtr.lastEmpenho.protocol ? `| Protocolo: <span class="protocol-badge">${vtr.lastEmpenho.protocol}</span>` : ''}</div>` : ''}
                `;
                content.appendChild(item);
            });

            modal.classList.add('active');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        function startTimers(){
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                renderUnits(); 
                checkTimeAlerts(); 
            }, 5000);
        }

        function checkTimeAlerts(){
            const now = Date.now();
            session.selectedUnits.forEach(uk=>{
                const vtrs = unitsData[uk]?.vtrs || [];
                vtrs.forEach((vtr,idx)=>{
                    if(!vtr.empenhos || vtr.empenhos.length === 0) return;
                    
                    const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                    const duration = (now - new Date(lastEmpenho.time)) / 60000;
                    const threshold = ALERT_THRESHOLDS[lastEmpenho.j];
                    
                    const alertKey = `${uk}-${idx}-${lastEmpenho.time}`;
                    
                    if(threshold && duration > threshold && !alertsShown.has(alertKey)){
                        alertsShown.add(alertKey);
                        showAlert(vtr.id, lastEmpenho.j, Math.floor(duration));
                    }
                });
            });
        }

        function showAlert(vtrId, j, mins){
            if(Notification.permission === 'granted'){
                new Notification('‚ö†Ô∏è Alerta de Tempo', {
                    body: `${vtrId} est√° em ${j} h√° ${mins} minutos`,
                    icon: 'üöî'
                });
            }
            console.warn(`ALERTA: ${vtrId} em ${j} h√° ${mins} min`);
        }

        if('Notification' in window && Notification.permission === 'default'){
            Notification.requestPermission();
        }

        // ====== Gerenciamento de VTRs (Mantido) ======
        function openVtrModal(unitKey, vtrIndex = null){
            const modal = document.getElementById('vtrModal');
            const container = document.getElementById('crewInputsContainer');
            container.innerHTML = '';
            editingVtr = {unitKey, vtrIndex};

            if(vtrIndex !== null){
                const vtr = unitsData[unitKey].vtrs[vtrIndex];
                document.getElementById('modalTitle').textContent = `Editar Viatura: ${vtr.id}`;
                document.getElementById('modalVtrId').value = vtr.id;
                document.getElementById('modalServiceType').value = vtr.service;
                document.getElementById('modalVtrPhone').value = vtr.phone || '';
                vtr.crew.forEach(member => addCrewInput(member.name, member.rank));
            } else {
                document.getElementById('modalTitle').textContent = `Adicionar Viatura em ${units[unitKey]}`;
                document.getElementById('modalVtrId').value = '';
                document.getElementById('modalServiceType').value = 'ORDINARIO';
                document.getElementById('modalVtrPhone').value = '';
                for(let i=0; i<3; i++) addCrewInput(); 
            }
            modal.classList.add('active');
        }

        function closeVtrModal(){
            document.getElementById('vtrModal').classList.remove('active');
            editingVtr = null;
        }

        document.getElementById('addCrewMember').addEventListener('click', () => addCrewInput());

        function addCrewInput(name = '', rank = ''){
            const container = document.getElementById('crewInputsContainer');
            if(container.children.length >= 5) return;
            
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = 'crew-input-group';
            div.innerHTML = `
                <div class="crew-input-header">
                    <h4>Membro ${idx + 1}</h4>
                    ${idx > 0 ? `<button type="button" class="danger small" onclick="this.closest('.crew-input-group').remove()">Remover</button>` : ''}
                </div>
                <div class="row">
                    <div class="col">
                        <label>Posto/Gradua√ß√£o</label>
                        <input type="text" class="crew-rank" value="${rank}" placeholder="Ex: Cap, Sgt, Sd" />
                    </div>
                    <div class="col">
                        <label>Nome de Guerra</label>
                        <input type="text" class="crew-name" value="${name}" placeholder="Ex: Silva, Junior" />
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        document.getElementById('saveVtrBtn').addEventListener('click', saveVtr);

        function saveVtr(){
            const {unitKey, vtrIndex} = editingVtr;
            const id = document.getElementById('modalVtrId').value.trim();
            const service = document.getElementById('modalServiceType').value;
            const phone = document.getElementById('modalVtrPhone').value.trim();
            
            const crew = Array.from(document.querySelectorAll('#crewInputsContainer .crew-input-group')).map(group => ({
                rank: group.querySelector('.crew-rank').value.trim(),
                name: group.querySelector('.crew-name').value.trim(),
            })).filter(m => m.rank || m.name);

            if(!id){
                alert('A Identifica√ß√£o da Viatura √© obrigat√≥ria.');
                return;
            }

            const newVtr = {
                id, service, crew, phone, unitKey,
                empenhos: vtrIndex !== null ? unitsData[unitKey].vtrs[vtrIndex].empenhos : []
            };

            if(vtrIndex !== null){
                unitsData[unitKey].vtrs[vtrIndex] = newVtr;
            } else {
                if(unitsData[unitKey].vtrs.some(v => v.id === id)){
                    alert(`A viatura com ID "${id}" j√° existe na unidade ${units[unitKey]}.`);
                    return;
                }
                unitsData[unitKey].vtrs.push(newVtr);
            }

            closeVtrModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
        }

        function deleteVtr(unitKey, vtrIndex){
            if(confirm(`Tem certeza que deseja remover a viatura ${unitsData[unitKey].vtrs[vtrIndex].id}?`)){
                unitsData[unitKey].vtrs.splice(vtrIndex, 1);
                renderUnits();
                updateDashboard();
                saveToLocal();
            }
        }

        function openEmpenhoModal(unitKey, vtrIndex){
            currentVtrForEmpenho = {unitKey, vtrIndex};
            const vtr = unitsData[unitKey].vtrs[vtrIndex];
            document.getElementById('modalVtrName').textContent = vtr.id;
            document.getElementById('modalEmpenhoJ').value = 'J1'; 
            document.getElementById('modalProtocol').value = '';
            document.getElementById('modalActions').value = '';
            document.getElementById('empenhoModal').classList.add('active');
        }

        function closeEmpenhoModal(){
            document.getElementById('empenhoModal').classList.remove('active');
            currentVtrForEmpenho = null;
        }

        document.getElementById('saveEmpenhoBtn').addEventListener('click', saveEmpenho);

        function saveEmpenho(){
            if(!currentVtrForEmpenho) return;
            const {unitKey, vtrIndex} = currentVtrForEmpenho;
            const vtr = unitsData[unitKey].vtrs[vtrIndex];

            const j = document.getElementById('modalEmpenhoJ').value;
            const protocol = document.getElementById('modalProtocol').value.trim();
            const actions = document.getElementById('modalActions').value.trim();
            
            performEmpenho(vtr, j, protocol, actions);

            closeEmpenhoModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
        }

        // ====== Empenho R√°pido (Mantido) ======
        document.getElementById('openQuickEmpenhoBtn').addEventListener('click', openQuickEmpenhoModal);

        function openQuickEmpenhoModal() {
            // Limpa o modal e exibe
            document.getElementById('quickSearchVtr').value = '';
            document.getElementById('quickSearchResult').innerHTML = 'Nenhuma viatura selecionada.';
            document.getElementById('quickEmpenhoForm').style.display = 'none';
            quickEmpenhoVtr = null;
            document.getElementById('quickEmpenhoModal').classList.add('active');
        }

        function closeQuickEmpenhoModal() {
            document.getElementById('quickEmpenhoModal').classList.remove('active');
        }

        function findVtrForQuickEmpenho() {
            const searchId = document.getElementById('quickSearchVtr').value.trim();
            const resultDiv = document.getElementById('quickSearchResult');
            const formDiv = document.getElementById('quickEmpenhoForm');
            quickEmpenhoVtr = null;
            formDiv.style.display = 'none';

            if (searchId.length < 2) {
                resultDiv.innerHTML = 'Digite pelo menos 2 caracteres para buscar.';
                return;
            }

            const found = findVtrById(searchId);

            if (found) {
                quickEmpenhoVtr = found;
                resultDiv.innerHTML = `
                    <div class="found-vtr">
                        Viatura Encontrada: <strong>${found.vtr.id}</strong> (${units[found.unitKey]})
                    </div>
                `;
                // Pr√©-preenche o J mais comum ou o J1
                const lastEmpenho = found.vtr.empenhos[found.vtr.empenhos.length - 1];
                document.getElementById('quickModalEmpenhoJ').value = (lastEmpenho && lastEmpenho.j !== 'J11') ? lastEmpenho.j : 'J1'; 
                document.getElementById('quickModalProtocol').value = '';
                document.getElementById('quickModalActions').value = '';
                formDiv.style.display = 'block';

            } else {
                resultDiv.innerHTML = `
                    <p>Viatura **${searchId}** n√£o encontrada ou n√£o montada.</p>
                    <p class="vtr-warning">Certifique-se que a ID esteja correta e que a VTR tenha sido cadastrada na unidade correta.</p>
                `;
            }
        }

        document.getElementById('saveQuickEmpenhoBtn').addEventListener('click', saveQuickEmpenho);

        function saveQuickEmpenho() {
            if (!quickEmpenhoVtr) {
                alert('Nenhuma viatura selecionada.');
                return;
            }

            const vtr = quickEmpenhoVtr.vtr;
            const j = document.getElementById('quickModalEmpenhoJ').value;
            const protocol = document.getElementById('quickModalProtocol').value.trim();
            const actions = document.getElementById('quickModalActions').value.trim();

            performEmpenho(vtr, j, protocol, actions);

            closeQuickEmpenhoModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
        }

        function performEmpenho(vtr, j, protocol, actions) {
            const now = new Date().toISOString();
            const newEmpenho = {
                j,
                time: now,
                protocol: protocol || null,
                actions: actions || null
            };
            vtr.empenhos.push(newEmpenho);
        }

        // ====== Renderiza√ß√£o e Filtro (Mantido) ======
        function renderUnits(){
            const container = document.getElementById('unitsContainer');
            container.innerHTML = '';
            const search = document.getElementById('searchVtr').value.toLowerCase();
            const filterService = document.getElementById('filterService').value;
            const filterUnit = document.getElementById('filterUnit').value;

            session.selectedUnits.forEach(uk => {
                if(filterUnit && filterUnit !== uk) return;

                const unitContainer = document.createElement('div');
                unitContainer.className = 'unit-card';
                unitContainer.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-title">
                            ${units[uk]}
                            <span class="small" id="vtrCount-${uk}">(${unitsData[uk].vtrs.length} Viaturas)</span>
                        </div>
                        <button class="small" onclick="openVtrModal('${uk}', null)">+ Nova VTR</button>
                    </div>
                    <div class="vtr-list" id="vtrList-${uk}"></div>
                `;
                container.appendChild(unitContainer);

                const vtrList = document.getElementById(`vtrList-${uk}`);
                let unitVtrCount = 0;
                
                unitsData[uk].vtrs.forEach((vtr, vtrIndex) => {
                    if(filterService && filterService !== vtr.service) return;
                    if(search && !vtr.id.toLowerCase().includes(search) && !vtr.crew.some(m => m.name.toLowerCase().includes(search))) return;
                    
                    unitVtrCount++;

                    const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                    const isAlert = lastEmpenho && ALERT_THRESHOLDS[lastEmpenho.j] && (Date.now() - new Date(lastEmpenho.time)) / 60000 > ALERT_THRESHOLDS[lastEmpenho.j];

                    const vtrItem = document.createElement('div');
                    vtrItem.className = 'vtr-item' + (isAlert ? ' alert' : '');
                    
                    const currentEmpenhoHtml = lastEmpenho ? `
                        <div class="vtr-badges">
                            <span class="vtr-service">${vtr.service}</span>
                            <span class="j-counter">${lastEmpenho.j}</span>
                            ${isAlert ? '<span class="alert-badge">ALERTA</span>' : ''}
                        </div>
                        <div class="vtr-duration" data-time="${lastEmpenho.time}">
                            ${timeDifference(lastEmpenho.time)}
                        </div>
                    ` : `
                        <div class="vtr-badges">
                            <span class="vtr-service">${vtr.service}</span>
                            <span class="j-counter" style="background:rgba(255,255,255,0.1);color:var(--muted)">Em Base</span>
                        </div>
                    `;

                    // HTML COMPACTO
                    vtrItem.innerHTML = `
                        <div class="vtr-info">
                            <div class="vtr-id">üöî ${vtr.id}</div>
                            ${currentEmpenhoHtml}
                        </div>
                        <div class="vtr-actions">
                            <button class="small success" onclick="openEmpenhoModal('${uk}', ${vtrIndex})">J +</button>
                            <button class="small ghost" onclick="openVtrModal('${uk}', ${vtrIndex})">Detalhes/Editar</button>
                            <button class="small danger" onclick="deleteVtr('${uk}', ${vtrIndex})">Excluir</button>
                        </div>
                    `;

                    vtrList.appendChild(vtrItem);
                });
                
                document.getElementById(`vtrCount-${uk}`).textContent = `(${unitVtrCount} Viaturas)`;
            });
        }
        
        // Atribui listeners aos filtros
        document.getElementById('searchVtr').addEventListener('input', renderUnits);
        document.getElementById('filterService').addEventListener('change', renderUnits);
        document.getElementById('filterUnit').addEventListener('change', renderUnits);

        // ====== Fun√ß√µes de Estat√≠sticas e An√°lise (Ajustadas) ======
        document.getElementById('openStatsBtn').addEventListener('click', openStatsModal);

        function openStatsModal() {
            document.getElementById('statsModal').classList.add('active');
            switchTab('charts');
            generateStatistics();
            drawCharts();
            generatePerformanceStats();
            generateOcurrenceList();
        }

        function closeStatsModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        function generateStatistics() {
            const stats = {
                empenhoCounts: {}, 
                hourCounts: {},    
                durations: [],     
            };

            session.selectedUnits.forEach(uk => {
                const vtrs = unitsData[uk]?.vtrs || [];
                vtrs.forEach(vtr => {
                    vtr.empenhos.forEach((empenho, index) => {
                        stats.empenhoCounts[empenho.j] = (stats.empenhoCounts[empenho.j] || 0) + 1;

                        const hour = new Date(empenho.time).getHours();
                        stats.hourCounts[hour] = (stats.hourCounts[hour] || 0) + 1;

                        if (index > 0) {
                            const prevEmpenho = vtr.empenhos[index - 1];
                            const startTime = new Date(prevEmpenho.time).getTime();
                            const endTime = new Date(empenho.time).getTime();
                            const durationMins = Math.floor((endTime - startTime) / 60000);
                            stats.durations.push({
                                j: prevEmpenho.j,
                                duration: durationMins
                            });
                        }
                    });
                });
            });

            return stats;
        }

        function drawCharts() {
            const stats = generateStatistics();

            if (empenhosChart) empenhosChart.destroy();
            const empenhoLabels = Object.keys(stats.empenhoCounts).sort();
            const empenhoData = empenhoLabels.map(label => stats.empenhoCounts[label]);

            const ctxEmpenhos = document.getElementById('chartEmpenhos').getContext('2d');
            empenhosChart = new Chart(ctxEmpenhos, {
                type: 'bar',
                data: {
                    labels: empenhoLabels,
                    datasets: [{
                        label: 'Ocorr√™ncias/Atividades',
                        data: empenhoData,
                        backgroundColor: 'rgba(6, 182, 212, 0.6)',
                        borderColor: 'rgba(6, 182, 212, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'var(--muted)' } },
                        x: { ticks: { color: 'var(--muted)' } }
                    }
                }
            });

            if (horarioChart) horarioChart.destroy();
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}h`);
            const hourData = hourLabels.map((_, i) => stats.hourCounts[i] || 0);

            const ctxHorario = document.getElementById('chartHorario').getContext('2d');
            horarioChart = new Chart(ctxHorario, {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Total de Empenhos',
                        data: hourData,
                        borderColor: 'var(--warning)',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'var(--muted)' } },
                        x: { ticks: { color: 'var(--muted)' } }
                    }
                }
            });
        }
        
        function generatePerformanceStats() {
            const container = document.getElementById('performanceStats');
            container.innerHTML = '';

            let allVtrs = [];
            session.selectedUnits.forEach(uk => {
                const unitName = units[uk];
                unitsData[uk]?.vtrs.forEach(vtr => {
                    if (vtr.empenhos.length > 0) {
                        
                        const vtrStats = {
                            id: vtr.id,
                            unit: unitName,
                            unitKey: uk,
                            vtrIndex: unitsData[uk].vtrs.findIndex(item => item.id === vtr.id),
                            totalEmpenhos: vtr.empenhos.length,
                            totalTempoMins: 0,
                            empenhosFinalizados: 0,
                            lastJ: vtr.empenhos[vtr.empenhos.length - 1].j
                        };
                        
                        let durations = [];
                        vtr.empenhos.forEach((empenho, index) => {
                            if (index > 0) {
                                const prevTime = new Date(vtr.empenhos[index - 1].time).getTime();
                                const currentTime = new Date(empenho.time).getTime();
                                const durationMins = Math.floor((currentTime - prevTime) / 60000);
                                durations.push(durationMins);
                                vtrStats.totalTempoMins += durationMins;
                            }
                        });

                        vtrStats.empenhosFinalizados = durations.length;
                        vtrStats.mediaTempoMins = vtrStats.empenhosFinalizados > 0 
                            ? Math.round(vtrStats.totalTempoMins / vtrStats.empenhosFinalizados) 
                            : 0;

                        allVtrs.push(vtrStats);
                    }
                });
            });

            if (allVtrs.length === 0) {
                container.innerHTML = '<p class="small" style="padding:20px;text-align:center;">Nenhuma viatura com empenhos registrados para gerar o relat√≥rio de desempenho.</p>';
                return;
            }

            // Exibi√ß√£o do resumo geral
            const totalEmpenhosFinalizados = allVtrs.reduce((sum, v) => sum + v.empenhosFinalizados, 0);
            const totalTempo = allVtrs.reduce((sum, v) => sum + v.totalTempoMins, 0);
            const mediaGeral = totalEmpenhosFinalizados > 0 ? Math.round(totalTempo / totalEmpenhosFinalizados) : 0;


            let performanceHtml = `
                <div class="card" style="margin-bottom:12px;display:flex;gap:16px;justify-content:space-around;">
                    <div style="text-align:center;">
                        <div class="stat-label">Total de Empenhos Finalizados</div>
                        <div class="stat-value" style="font-size:24px;color:var(--success);">${totalEmpenhosFinalizados}</div>
                    </div>
                    <div style="text-align:center;">
                        <div class="stat-label">Tempo M√©dio Total (min)</div>
                        <div class="stat-value" style="font-size:24px;color:var(--accent);">${mediaGeral}m</div>
                    </div>
                </div>

                <h3>Desempenho Individual das Viaturas Ativas</h3>
                <table class="performance-table" style="width:100%;border-collapse:collapse;text-align:left;">
                    <thead>
                        <tr>
                            <th>Viatura</th>
                            <th>Unidade</th>
                            <th>Total J's</th>
                            <th>J Atual</th>
                            <th>M√©dia Tempo (min)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allVtrs.map(vtr => `
                            <tr style="cursor:pointer;" title="Clique para ver os detalhes" onclick="openVtrDetailsModal('${vtr.unitKey}', ${vtr.vtrIndex})">
                                <td style="font-weight:600;">üöî ${vtr.id}</td>
                                <td style="font-size:13px;color:var(--muted);">${vtr.unit}</td>
                                <td>${vtr.totalEmpenhos}</td>
                                <td style="font-weight:600;color:var(--warning);">${vtr.lastJ}</td>
                                <td style="color:${vtr.mediaTempoMins > 0 ? 'var(--accent)' : 'var(--muted)'};">${vtr.mediaTempoMins}m</td>
                                <td><button class="small ghost" onclick="event.stopPropagation(); openVtrDetailsModal('${vtr.unitKey}', ${vtr.vtrIndex})">Ver Hist√≥rico</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = performanceHtml;
        }

        // NOVO: Modal de detalhes da VTR
        function openVtrDetailsModal(unitKey, vtrIndex) {
            const modal = document.getElementById('vtrDetailsModal');
            const title = document.getElementById('vtrDetailsModalTitle');
            const content = document.getElementById('vtrDetailsModalContent');
            content.innerHTML = '';
            
            const vtr = unitsData[unitKey].vtrs[vtrIndex];
            title.textContent = `Hist√≥rico Detalhado: üöî ${vtr.id} (${units[unitKey]})`;

            const headerHtml = `
                <div style="margin-bottom:15px; background:rgba(6,182,212,0.1); padding:15px; border-radius:8px;">
                    <h4 style="margin:0; color:var(--accent);">Informa√ß√µes da Viatura</h4>
                    <div class="small" style="margin-top:5px;">
                        **Servi√ßo:** ${vtr.service} | **Unidade:** ${units[unitKey]} | **Telefone:** ${vtr.phone || 'N/A'}
                    </div>
                    <div class="small" style="margin-top:5px;">
                        **Tripula√ß√£o:** ${vtr.crew.map(m => `${m.rank} ${m.name}`).filter(s => s.trim()).join(' / ') || 'N√£o informada'}
                    </div>
                </div>
                
                <h3 style="margin-top:20px;">Hist√≥rico de Empenhos (${vtr.empenhos.length} Registros)</h3>
            `;
            content.innerHTML += headerHtml;

            if (vtr.empenhos.length === 0) {
                content.innerHTML += '<p class="small" style="text-align:center;">Nenhum empenho registrado para esta viatura.</p>';
            } else {
                vtr.empenhos.slice().reverse().forEach((empenho, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'empenho-history-item';
                    
                    const time = new Date(empenho.time).toLocaleString('pt-BR');
                    const isLast = index === 0;
                    
                    let durationHtml = '';
                    if (empenho.j !== 'J11' && index < vtr.empenhos.length - 1) {
                         // Calcula a dura√ß√£o do J anterior at√© este J atual (se n√£o for o √∫ltimo)
                         const nextEmpenho = vtr.empenhos[vtr.empenhos.length - 2 - index];
                         const duration = timeDifference(empenho.time, nextEmpenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--success);">Dura√ß√£o at√© o pr√≥ximo J: ${duration}</span>`;
                    } else if (isLast) {
                        // Calcula a dura√ß√£o do J atual at√© agora
                        const duration = timeDifference(empenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--warning);">Dura√ß√£o Atual: ${duration}</span>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${empenho.j}: ${getJText(empenho.j).split(': ')[1]}</strong>
                            ${durationHtml}
                        </div>
                        <div class="small">
                            In√≠cio: ${time} ${empenho.protocol ? `| Protocolo: **${empenho.protocol}**` : ''}
                        </div>
                        ${empenho.actions ? `
                            <div class="small" style="margin-top:5px;">**A√ß√µes Empregadas:**</div>
                            <pre>${empenho.actions}</pre>
                        ` : ''}
                    `;
                    content.appendChild(itemDiv);
                });
            }

            modal.classList.add('active');
        }

        function closeVtrDetailsModal() {
            document.getElementById('vtrDetailsModal').classList.remove('active');
        }

        function generateOcurrenceList() {
            const container = document.getElementById('occurrenceList');
            container.innerHTML = '';
            const searchProtocol = document.getElementById('searchProtocol').value.toLowerCase().trim();
            
            const empenhosComDados = [];

            session.selectedUnits.forEach(uk => {
                const unitName = units[uk];
                unitsData[uk]?.vtrs.forEach(vtr => {
                    vtr.empenhos.forEach(empenho => {
                        if (empenho.protocol || empenho.actions) {
                            empenhosComDados.push({
                                unit: unitName,
                                vtrId: vtr.id,
                                j: empenho.j,
                                protocol: empenho.protocol,
                                actions: empenho.actions,
                                time: empenho.time
                            });
                        }
                    });
                });
            });

            empenhosComDados.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            const filteredEmpenhos = empenhosComDados.filter(item => {
                if (!searchProtocol) return true;
                return item.protocol && item.protocol.toLowerCase().includes(searchProtocol);
            });


            if (filteredEmpenhos.length === 0) {
                 container.innerHTML = `<p class="small" style="padding:20px;text-align:center;">Nenhuma ocorr√™ncia ou registro de a√ß√£o encontrado para o filtro de protocolo "${searchProtocol}".</p>`;
                 return;
            }

            filteredEmpenhos.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'occurrence-item';
                
                const protocolHtml = item.protocol 
                    ? `<span class="occurrence-protocol">Protocolo: ${item.protocol}</span>`
                    : '<span class="occurrence-protocol" style="background:rgba(255,255,255,0.05);color:var(--muted)">Sem Protocolo</span>';

                itemDiv.innerHTML = `
                    <div class="occurrence-header">
                        <div>
                            <div class="occurrence-vtr">üöî ${item.vtrId} (${item.unit})</div>
                            <div class="small" style="color:var(--muted);margin-top:2px;">${new Date(item.time).toLocaleString('pt-BR')}</div>
                        </div>
                        ${protocolHtml}
                    </div>
                    <div class="occurrence-j">${item.j}: ${getJText(item.j).split(': ')[1]}</div>
                    <div class="occurrence-actions">
                        <strong>A√ß√µes Empregadas:</strong> 
                        ${item.actions || '<em style="color:var(--muted)">Nenhuma a√ß√£o detalhada registrada.</em>'}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"`).classList.add('active');
            
            if (tabId === 'charts') {
                drawCharts();
            } else if (tabId === 'performance') {
                generatePerformanceStats();
            } else if (tabId === 'occurrences') { 
                generateOcurrenceList();
            }
        }
        
        // ====== Fun√ß√µes de Exporta√ß√£o (CSV e PDF) (Mantidas) ======

        function getFullEmpenhoData() {
            let data = [];
            session.selectedUnits.forEach(uk => {
                const unitName = units[uk];
                unitsData[uk]?.vtrs.forEach(vtr => {
                    vtr.empenhos.forEach(empenho => {
                        data.push({
                            'ID_SESSAO': session.id,
                            'UNIDADE': unitName,
                            'ID_VTR': vtr.id,
                            'SERVICO_VTR': vtr.service,
                            'J': empenho.j,
                            'DESCRICAO_J': getJText(empenho.j).split(': ')[1],
                            'HORA_INICIO': new Date(empenho.time).toLocaleString('pt-BR'),
                            'PROTOCOLO': empenho.protocol || '',
                            'ACOES_EMPREGADAS': empenho.actions ? empenho.actions.replace(/(\r\n|\n|\r)/gm, " ").trim() : ''
                        });
                    });
                });
            });
            return data;
        }

        document.getElementById('exportCsv').addEventListener('click', exportCsv);

        function exportCsv() {
            const data = getFullEmpenhoData();
            if (data.length === 0) {
                alert('Nenhum dado de empenho para exportar.');
                return;
            }

            const headers = Object.keys(data[0]);
            
            let csv = [
                headers.join(';') 
            ];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let val = row[header];
                    if (typeof val === 'string' && (val.includes(';') || val.includes('\n'))) {
                         val = `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                });
                csv.push(values.join(';'));
            });
            
            const csvContent = "\ufeff" + csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Mapa_Forca_Empenhos_${session.id}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Exporta√ß√£o CSV conclu√≠da com sucesso!');
        }

        document.getElementById('exportPdf').addEventListener('click', exportPdf);

        function exportPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            let y = 10;
            
            doc.setFontSize(16);
            doc.text('Relat√≥rio do Mapa da For√ßa', 10, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.text(`Operador: ${session.operator}`, 10, y);
            doc.text(`In√≠cio do Turno: ${new Date(session.datetime).toLocaleString('pt-BR')}`, 100, y);
            y += 5;
            
            const totalVtrs = document.querySelector('[onclick="openDetailsModal(\'total\')"] .stat-value').textContent;
            const activeVtrs = document.querySelector('[onclick="openDetailsModal(\'active\')"] .stat-value').textContent;
            doc.text(`Viaturas Total: ${totalVtrs} | Viaturas Ativas: ${activeVtrs}`, 10, y);
            y += 10;
            
            const empenhoData = getFullEmpenhoData();
            const tableColumns = [
                { header: 'ID VTR', dataKey: 'ID_VTR' },
                { header: 'Unidade', dataKey: 'UNIDADE' },
                { header: 'J', dataKey: 'J' },
                { header: 'In√≠cio', dataKey: 'HORA_INICIO' },
                { header: 'Protocolo', dataKey: 'PROTOCOLO' },
                { header: 'A√ß√µes', dataKey: 'ACOES_EMPREGADAS' },
            ];
            
            const tableRows = empenhoData.map(row => tableColumns.map(col => row[col.dataKey]));
            
            doc.setFontSize(12);
            doc.text('Tabela Detalhada de Empenhos Registrados:', 10, y);
            y += 5;

            doc.autoTable({
                startY: y,
                head: [tableColumns.map(c => c.header)],
                body: tableRows,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [6, 182, 212] },
                margin: { top: 10, left: 10, right: 10 },
                columnStyles: {
                    4: { cellWidth: 30 }, 
                    5: { cellWidth: 50 }  
                }
            });

            doc.save(`Mapa_Forca_Relatorio_${session.id}.pdf`);
            alert('Exporta√ß√£o PDF conclu√≠da com sucesso!');
        }

    </script>
</body>
</html>
