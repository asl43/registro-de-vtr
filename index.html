<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mapa da For√ßa ‚Äî Controle de Unidades</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #0b1220;
            --text-primary: #e6eef6;
            --text-muted: #94a3b8;
            --glass: rgba(255, 255, 255, 0.04);
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient: linear-gradient(180deg, #06202a 0%, #071425 100%);
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        }
        .light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --text-primary: #1f2937;
            --text-muted: #6b7280;
            --glass: rgba(0, 0, 0, 0.04);
            --border-color: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(180deg, #f0f4f7 0%, #ffffff 100%);
            --accent: #0284c7;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,Helvetica,Arial}
        body{margin:0;background:var(--gradient);color:var(--text-primary);min-height:100vh;padding:24px;transition:background 0.3s, color 0.3s}
        .app{width:100%;max-width:1400px;margin:0 auto}
        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:12px}
        h1{font-size:20px;margin:0}
        h2{font-size:18px;margin:12px 0 8px}
        h3{font-size:15px;margin:8px 0;color:var(--accent)}
        .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);margin-bottom:14px;transition:background 0.3s, box-shadow 0.3s}
        label{font-size:13px;color:var(--text-muted);display:block;margin-bottom:4px}
        input[type=text],input[type=datetime-local],select,input[type=tel],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--glass);color:var(--text-primary);font-size:14px;transition:background 0.3s, color 0.3s, border-color 0.3s}
        textarea{resize:vertical;min-height:80px}
        .row{display:flex;gap:12px;margin-bottom:12px}
        .col{flex:1}
        button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:white;cursor:pointer;font-weight:600;font-size:13px;transition:opacity 0.2s, background 0.3s, color 0.3s}
        button:hover{opacity:0.9}
        button:disabled{opacity:0.5;cursor:not-allowed}
        button.ghost{background:transparent;border:1px solid var(--border-color);color:var(--text-muted)}
        button.danger{background:var(--danger);color:white}
        button.success{background:var(--success);color:white}
        button.small{padding:6px 10px;font-size:12px}
        .multi-select{background:var(--glass);border-radius:8px;border:1px solid var(--border-color);padding:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;transition: background 0.3s, border-color 0.3s}
        .unit-checkbox{color:var(--text-primary)}
        .unit-checkbox label{color:var(--text-primary);font-size:14px;margin-bottom:0}
        .dashboard-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px}
        .units-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
        .stat-card{background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);padding:16px;border-radius:8px;text-align:center;transition: background 0.3s, border-color 0.3s}
        .light-mode .stat-card{background: rgba(2, 132, 199, 0.1);border: 1px solid rgba(2, 132, 199, 0.3)}
        .stat-value{font-size:28px;font-weight:700;color:var(--accent)}
        .stat-label{font-size:12px;color:var(--text-muted)}
        .unit-card{background:var(--card);border-radius:12px;padding:15px;box-shadow:var(--shadow)}
        .unit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
        .unit-title{font-weight:600;font-size:16px;color:var(--text-primary)}
        .vtr-list{display:flex;flex-direction:column;gap:10px}
        .vtr-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--glass);border:1px solid var(--border-color);transition: background 0.3s, border-color 0.3s}
        .vtr-item.alert{border-color:var(--danger);animation:pulse-red 1.5s infinite}
        .vtr-info{flex-grow:1}
        .vtr-id{font-weight:600;font-size:15px;color:var(--text-primary)}
        .vtr-actions{display:flex;gap:6px;margin-left:10px}
        .vtr-badges{display:flex;gap:4px;margin-top:4px;align-items:center}
        .vtr-service{background:rgba(16,185,129,0.2);color:var(--success);padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
        .j-counter{background:rgba(245,158,11,0.2);color:var(--warning);padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
        .vtr-duration{font-size:14px;font-weight:600;color:var(--warning);margin-left:8px}
        .alert-badge{background:var(--danger);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-left:4px}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.85);padding-top:60px}
        .modal.active{display:block}
        .modal-content{background:var(--card);margin:5% auto;padding:20px;border-radius:12px;width:90%;max-width:500px;box-shadow:var(--shadow);transition: background 0.3s}
        .modal-content[style*="max-width:800px"]{max-width: 800px !important}
        .modal-content[style*="max-width:900px"]{max-width: 900px !important}
        .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:10px;margin-bottom:15px}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{color:var(--text-muted);font-size:28px;font-weight:bold;cursor:pointer}
        .modal-close:hover,.modal-close:focus{color:var(--text-primary);text-decoration:none}
        .chip{display:inline-block;background:var(--glass);color:var(--text-primary);padding:4px 10px;border-radius:16px;font-size:12px;border:1px solid var(--border-color)}
        .small{font-size:12px;color:var(--text-muted)}
        .crew-input-group{border:1px solid var(--border-color);padding:10px;border-radius:8px;margin-bottom:10px;background:var(--glass);transition: background 0.3s, border-color 0.3s}
        .crew-input-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .crew-input-header h4{margin:0;font-size:14px;color:var(--accent)}
        .search-filter-bar{display:flex;gap:12px;align-items:center}
        .search-box{flex:1}
        .search-box input{margin-bottom:0}
        #quickSearchResult{margin-top: 15px;padding: 10px;border-radius: 6px;border: 1px solid var(--border-color);color: var(--text-muted)}
        .found-vtr{background: rgba(6, 182, 212, 0.1);color: var(--accent);padding: 5px;border-radius: 4px}
        .light-mode .found-vtr{background: rgba(2, 132, 199, 0.1)}
        .vtr-warning{color: var(--danger);font-size: 11px;margin-top: 5px}
        .tabs{display: flex;border-bottom: 1px solid var(--border-color);margin-bottom: 15px}
        .tab{background: none;border: none;padding: 10px 15px;cursor: pointer;color: var(--text-muted);border-bottom: 2px solid transparent;font-weight: 500;transition: all 0.2s}
        .tab:hover{color: var(--text-primary)}
        .tab.active{color: var(--accent);border-bottom-color: var(--accent);font-weight: 600}
        .tab-content{display: none}
        .tab-content.active{display: block}
        .chart-container{margin-bottom: 25px}
        .performance-table, .service-table{width: 100%;border-collapse: collapse;text-align: left}
        .performance-table th, .performance-table td, .service-table th, .service-table td{padding: 10px 12px;border-bottom: 1px solid var(--border-color)}
        .performance-table th, .service-table th{background: var(--glass)}
        .performance-table tr:hover, .service-table tr:hover{background: var(--glass)}
        .occurrence-item{background: var(--glass);border-radius: 8px;padding: 15px;margin-bottom: 10px;border-left: 4px solid var(--warning);transition: background 0.3s}
        .occurrence-header{display: flex;justify-content: space-between;align-items: center;margin-bottom: 8px}
        .occurrence-vtr{font-weight: 600;color: var(--accent)}
        .occurrence-protocol{background: var(--card);color: var(--accent);padding: 4px 8px;border-radius: 6px;font-size: 12px;font-weight: 600;border: 1px solid var(--border-color);transition: background 0.3s}
        .occurrence-j{font-size: 14px;font-weight: 500;color: var(--text-primary);margin-bottom: 10px;padding-bottom: 5px;border-bottom: 1px dashed var(--border-color)}
        .occurrence-actions{font-size: 13px;color: var(--text-primary)}
        .occurrence-actions strong{color: var(--text-muted);font-weight: 600}
        .empenho-history-item{background: var(--glass);border-radius: 8px;padding: 10px;margin-bottom: 10px;border-left: 3px solid var(--accent)}
        .empenho-history-item pre{white-space: pre-wrap;word-wrap: break-word;padding: 8px;margin-top: 5px;border-radius: 4px;background: rgba(0,0,0,0.2);color: var(--text-primary);font-size: 13px}
        .light-mode .empenho-history-item pre{background: rgba(0,0,0,0.05);color: var(--text-primary)}
        .empenho-history-item strong{color: var(--warning)}
        .theme-icon{font-size: 16px;margin-right: 4px}
        .sync-badge{display:inline-block;background:rgba(16,185,129,0.2);color:var(--success);padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px}
        .sync-badge.syncing{background:rgba(245,158,11,0.2);color:var(--warning);animation:pulse 1s infinite}
        .sync-badge.error{background:rgba(239,68,68,0.2);color:var(--danger)}
        .notification{position:fixed;top:20px;right:20px;background:var(--card);border-left:4px solid var(--success);padding:15px 20px;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.4);max-width:350px;z-index:9999;animation:slideIn 0.3s ease-out;display:flex;align-items:center;gap:12px}
        .notification.error{border-left-color:var(--danger)}
        .notification.warning{border-left-color:var(--warning)}
        .notification .notif-icon{font-size:20px}
        .notification .notif-text{flex:1;font-size:13px}
        @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes pulse{0%, 100%{opacity:1}50%{opacity:0.5}}
        @keyframes pulse-red{0%{box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4)}70%{box-shadow: 0 0 0 10px rgba(239, 68, 68, 0)}100%{box-shadow: 0 0 0 0 rgba(239, 68, 68, 0)}}
        @media (max-width:900px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:700px){.row{flex-direction:column}.dashboard-grid{grid-template-columns:1fr}header{flex-direction:column;align-items:flex-start}.search-filter-bar{flex-direction:column;gap:8px}.search-box{width:100%}}
    </style>
</head>
<body id="appBody">
    <div class="app">
        <header>
            <h1>
                üöî Mapa da For√ßa ‚Äî Controle de Unidades
                <span class="sync-badge" id="syncStatus">‚óè Verificando...</span>
            </h1>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="toggleThemeBtn" class="ghost small" onclick="toggleTheme()">
                    <span class="theme-icon">üåô</span> <span id="themeText">Modo Claro</span>
                </button>
                <button id="syncNowBtn" class="success small" onclick="sincronizarTudo()" disabled>
                    ‚òÅÔ∏è Sincronizar Agora
                </button>
                <button id="openQuickEmpenhoBtn" class="success small">‚ö° Empenho R√°pido</button>
                <button id="openStatsBtn" class="ghost small">üìä Estat√≠sticas</button>
            </div>
        </header>

        <section class="card" id="screen1">
            <h2>Passo 1 ‚Äî Informa√ß√µes da Opera√ß√£o</h2>
            <div class="row">
                <div class="col">
                    <label>Nome do Operador *</label>
                    <input id="operatorName" type="text" placeholder="Seu nome completo" required />
                </div>
                <div class="col">
                    <label>Data e Hora de In√≠cio *</label>
                    <input id="dateTime" type="datetime-local" required />
                </div>
            </div>
            <div style="margin-top:16px">
                <label>Selecione as Unidades para Controlar *</label>
                <div class="multi-select" id="unitsMultiSelect"></div>
            </div>
            <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
                <div class="small">
                    <span id="syncInfo">Dados sincronizados automaticamente com Google Sheets</span>
                </div>
                <button id="toStep2">Iniciar Controle ‚Üí</button>
            </div>
        </section>

        <section id="screen2" style="display:none">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px">
                    <div>
                        <div class="chip">üë§ <strong id="opSummary"></strong></div>
                        <div class="chip" style="margin-left:8px">üìÖ <strong id="dtSummary"></strong></div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button id="openAddUnitBtn" class="ghost small" onclick="openAddUnitModal()">+ Unidade</button> 
                        <button id="openRemoveUnitBtn" class="ghost small" onclick="openRemoveUnitModal()">- Unidade</button> 
                        <button id="openRestoreUnitBtn" class="ghost small" onclick="openRestoreUnitModal()">üîÑ Restaurar</button> 
                        <button id="exportPdf" class="ghost small">üìÑ PDF</button>
                        <button id="exportCsv" class="ghost small">üìä CSV</button>
                        <button id="saveLocal" class="success small">üíæ Salvar Local</button>
                        <button id="finishBtn" class="danger small">Finalizar</button>
                    </div>
                </div>
                <div class="dashboard-grid" id="dashboardStats"></div>
            </div>
            <div class="card">
                <div class="search-filter-bar">
                    <div class="search-box">
                        <input type="text" id="searchVtr" placeholder="üîç Buscar viatura por ID ou tripulante..." />
                    </div>
                    <select id="filterService" style="width:200px">
                        <option value="">Todos os Servi√ßos</option>
                        <option value="ORDINARIO">ORDIN√ÅRIO</option>
                        <option value="SEG">SEG</option>
                        <option value="POG">POG</option>
                        <option value="OPERA√á√ÉO">OPERA√á√ÉO</option>
                    </select>
                    <select id="filterUnit" style="width:200px">
                        <option value="">Todas as Unidades</option>
                    </select>
                </div>
            </div>
            <div class="units-grid" id="unitsContainer"></div>
        </section>

        <div class="modal" id="addUnitModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Adicionar Unidades ao Controle</div>
                    <button class="modal-close" onclick="closeAddUnitModal()">√ó</button>
                </div>
                <p class="small">Selecione as unidades que deseja incluir na sua sess√£o de controle.</p>
                <div class="multi-select" id="unitsToAddContainer"></div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeAddUnitModal()">Cancelar</button>
                    <button id="addUnitsBtn" class="success" onclick="addSelectedUnits()">Adicionar Unidades</button>
                </div>
            </div>
        </div>

        <div class="modal" id="removeUnitModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Remover Unidades do Controle</div>
                    <button class="modal-close" onclick="closeRemoveUnitModal()">√ó</button>
                </div>
                <p class="small">Selecione a unidade que deseja remover. Os dados de empenho ser√£o **salvos** no hist√≥rico da sess√£o.</p>
                <div style="margin-top:16px;">
                    <label>Unidade a ser removida do controle ativo</label>
                    <select id="unitToRemoveSelect"></select>
                </div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeRemoveUnitModal()">Cancelar</button>
                    <button id="removeUnitBtn" class="danger">Remover e Salvar Dados</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="restoreUnitModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">üîÑ Restaurar Unidades Removidas</div>
                    <button class="modal-close" onclick="closeRestoreUnitModal()">√ó</button>
                </div>
                <p class="small">Selecione a unidade que deseja **restaurar** para o controle ativo. Os dados de empenho ser√£o mantidos.</p>
                <div style="margin-top:16px;">
                    <label>Unidade a ser restaurada</label>
                    <select id="unitToRestoreSelect"></select>
                </div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeRestoreUnitModal()">Cancelar</button>
                    <button id="restoreUnitBtn" class="success">Restaurar para Controle Ativo</button>
                </div>
            </div>
        </div>

        <div class="modal" id="vtrModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Adicionar Viatura</div>
                    <button class="modal-close" onclick="closeVtrModal()">√ó</button>
                </div>
                <div>
                    <label>Identifica√ß√£o da Viatura *</label>
                    <input id="modalVtrId" type="text" placeholder="Ex: VTR-001, Guarni√ß√£o 01" />
                </div>
                <div style="margin-top:12px">
                    <label>Tipo de Servi√ßo *</label>
                    <select id="modalServiceType">
                        <option value="ORDINARIO">ORDIN√ÅRIO</option>
                        <option value="SEG">SEG</option>
                        <option value="POG">POG</option>
                        <option value="OPERA√á√ÉO">OPERA√á√ÉO</option>
                    </select>
                </div>
                <div style="margin-top:16px">
                    <h3 style="margin-bottom:12px">Equipe da Viatura (at√© 5 membros)</h3>
                    <div id="crewInputsContainer"></div>
                    <button id="addCrewMember" class="ghost small" style="margin-top:8px">+ Adicionar Membro</button>
                </div>
                <div style="margin-top:12px">
                    <label>Telefone de Contato</label>
                    <input id="modalVtrPhone" type="tel" placeholder="(92) 9xxxx-xxxx" />
                </div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeVtrModal()">Cancelar</button>
                    <button id="saveVtrBtn" class="success">Salvar Viatura</button>
                </div>
            </div>
        </div>

        <div class="modal" id="empenhoModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Registrar Empenho J</div>
                    <button class="modal-close" onclick="closeEmpenhoModal()">√ó</button>
                </div>
                <div class="small" style="margin-bottom:12px;background:rgba(6,182,212,0.1);padding:8px;border-radius:6px">
                    Viatura: <strong id="modalVtrName"></strong>
                </div>
                <div>
                    <label>Empenho J *</label>
                    <select id="modalEmpenhoJ"></select>
                </div>
                <div style="margin-top:12px">
                    <label>N√∫mero de Protocolo</label>
                    <input id="modalProtocol" type="text" placeholder="Ex: 2024-12345" />
                </div>
                <div style="margin-top:12px">
                    <label>A√ß√µes Empregadas</label>
                    <textarea id="modalActions" placeholder="Descreva as a√ß√µes realizadas..."></textarea>
                </div>
                <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                    <button class="ghost" onclick="closeEmpenhoModal()">Cancelar</button>
                    <button id="saveEmpenhoBtn" class="success">Registrar Empenho</button>
                </div>
            </div>
        </div>

        <div class="modal" id="quickEmpenhoModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‚ö° Empenho R√°pido por Viatura</div>
                    <button class="modal-close" onclick="closeQuickEmpenhoModal()">√ó</button>
                </div>
                <div>
                    <label>Buscar Identifica√ß√£o da Viatura (Ex: VTR-001)</label>
                    <input id="quickSearchVtr" type="text" placeholder="Digite a ID da VTR" />
                </div>
                <div id="quickSearchResult">Nenhuma viatura selecionada.</div>
                <div id="quickEmpenhoForm" style="display:none;">
                    <div style="margin-bottom:12px;">
                        <label>Empenho J *</label>
                        <select id="quickModalEmpenhoJ"></select>
                    </div>
                    <div style="margin-top:12px">
                        <label>N√∫mero de Protocolo</label>
                        <input id="quickModalProtocol" type="text" placeholder="Ex: 2024-12345" />
                    </div>
                    <div style="margin-top:12px">
                        <label>A√ß√µes Empregadas</label>
                        <textarea id="quickModalActions" placeholder="Descreva as a√ß√µes realizadas..."></textarea>
                    </div>
                    <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
                        <button class="ghost" onclick="closeQuickEmpenhoModal()">Cancelar</button>
                        <button id="saveQuickEmpenhoBtn" class="success">Registrar Empenho</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="detailsModal">
            <div class="modal-content" style="max-width:800px">
                <div class="modal-header">
                    <div class="modal-title" id="detailsModalTitle">Detalhes das Viaturas</div>
                    <button class="modal-close" onclick="closeDetailsModal()">√ó</button>
                </div>
                <div id="detailsModalContent" style="max-height:60vh; overflow-y:auto;"></div>
            </div>
        </div>
        
        <div class="modal" id="statsModal">
            <div class="modal-content" style="max-width:900px">
                <div class="modal-header">
                    <div class="modal-title">üìä Estat√≠sticas e An√°lises</div>
                    <button class="modal-close" onclick="closeStatsModal()">√ó</button>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('charts')">üìà Gr√°ficos</button>
                    <button class="tab" onclick="switchTab('performance')">‚è±Ô∏è Desempenho</button>
                    <button class="tab" onclick="switchTab('service_unit')">üöî Servi√ßo/Unidade</button> 
                    <button class="tab" onclick="switchTab('occurrences')">üö® Ocorr√™ncias</button>
                </div>
                <div class="tab-content active" id="tab-charts">
                    <div class="chart-container">
                        <h3>Distribui√ß√£o de Empenhos por Tipo (J)</h3>
                        <canvas id="chartEmpenhos"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Frequ√™ncia de Empenhos por Hor√°rio</h3>
                        <canvas id="chartHorario"></canvas>
                    </div>
                </div>
                <div class="tab-content" id="tab-performance">
                    <div id="performanceStats"></div>
                </div>
                <div class="tab-content" id="tab-service_unit">
                     <div id="serviceUnitStats"></div>
                </div>
                <div class="tab-content" id="tab-occurrences">
                    <div class="search-box" style="margin-bottom:15px;">
                        <input type="text" id="searchProtocol" placeholder="üîç Buscar por n√∫mero de Protocolo..." oninput="generateOcurrenceList()" />
                    </div>
                    <h3 style="margin-bottom:16px;">Registros de Ocorr√™ncias com A√ß√µes e Protocolos</h3>
                    <div id="occurrenceList"></div>
                </div>
            </div>
        </div>

        <div class="modal" id="vtrDetailsModal">
            <div class="modal-content" style="max-width:800px">
                <div class="modal-header">
                    <div class="modal-title" id="vtrDetailsModalTitle">Detalhes da Viatura</div>
                    <button class="modal-close" onclick="closeVtrDetailsModal()">√ó</button>
                </div>
                <div id="vtrDetailsModalContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DA API GOOGLE SHEETS
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxvRs8csW9hP8DNEQDy7az9a9UfVyDNF8AX3x2nxryYlRe7oC5cQhHtYxPN31x9lH5jhA/exec';
        
        let API_STATUS = {
            conectado: false,
            ultimaSync: null,
            tentativas: 0
        };

        // ==========================================
        // DADOS DO SISTEMA
        // ==========================================
        const units = {
            '25DIP': '25 CICOM','11DIP': '11 CICOM','28DIP': '28 CICOM','29DIP': '29 CICOM',
            '01DIP': '1 CICOM','02DIP': '2 CICOM','03DIP': '3 CICOM','04DIP': '4 CICOM',
            '05DIP': '5 CICOM','06DIP': '6 CICOM','07DIP': '7 CICOM','08DIP': '8 CICOM',
            '09DIP': '9 CICOM','10DIP': '10 CICOM','12DIP': '12 CICOM','13DIP': '13 CICOM',
            '14DIP': '14 CICOM','15DIP': '15 CICOM','16DIP': '16 CICOM','17DIP': '17 CICOM',
            '18DIP': '18 CICOM','19DIP': '19 CICOM','20DIP': '20 CICOM','21DIP': '21 CICOM',
            '22DIP': '22 CICOM','23DIP': '23 CICOM','24DIP': '24 CICOM','26DIP': '26 CICOM',
            '27DIP': '27 CICOM','30DIP': '30 CICOM',
            'CPA NORTE': 'CPA NORTE','CPA SUL': 'CPA SUL','CPA LESTE': 'CPA LESTE','CPA OESTE': 'CPA OESTE',
            'CPA C. SUL/C. OESTE': 'CPA C. SUL/C. OESTE',
            'FT': 'FT','BPTRAN': 'BPTRAN','CPTUR': 'CPTUR','RMP': 'RMP','CICLO': 'CICLO',
            'ROCAM': 'ROCAM','CHOQUE': 'CHOQUE','MARTE': 'MARTE','RPMON': 'RPMON','CIPC√ÉES': 'CIPC√ÉES',
            'COE': 'COE','BPAMB': 'BPAMB','CECOPOM': 'CECOPOM','GRAER': 'GRAER','BPG': 'BPG','NPPM': 'NPPM'
        };

        const empenhosJ = [
            {value:'J1',text:'J1: Atividade Fim'},{value:'J2',text:'J2: Atividade administrativa'},
            {value:'J3',text:'J3: Substitui√ß√£o de Guarni√ß√£o PM'},{value:'J4',text:'J4: Refei√ß√£o'},
            {value:'J5',text:'J5: Abastecimento'},{value:'J6',text:'J6: Limpeza de viatura'},
            {value:'J7',text:'J7: Manuten√ß√£o mec√¢nica'},{value:'J8',text:'J8: Necessidades Fisiol√≥gicas'},
            {value:'J9',text:'J9: Deslocamento para ocorr√™ncia'},{value:'J10',text:'J10: Chegada no local da ocorr√™ncia'},
            {value:'J11',text:'J11: Sa√≠da do local da ocorr√™ncia'},{value:'J12',text:'J12: Guarni√ß√£o na base'},
            {value:'J15',text:'J15: Opera√ß√£o Policial Militar'}
        ];

        const ALERT_THRESHOLDS = {J10:30,J9:20,J1:60};

        let session = {operator:'',datetime:'',selectedUnits:[],id:null};
        let unitsData = {};
        let removedUnitsData = {};
        let vtrHistoryData = [];
        let editingVtr = null;
        let currentVtrForEmpenho = null; 
        let quickEmpenhoVtr = null; 
        let timerInterval = null;
        let alertsShown = new Set();
        let empenhosChart = null; 
        let horarioChart = null;

        // ==========================================
        // FUN√á√ïES DE INTEGRA√á√ÉO COM GOOGLE SHEETS
        // ==========================================

        async function enviarParaSheets(acao, dados) {
            const statusBadge = document.getElementById('syncStatus');
            const syncBtn = document.getElementById('syncNowBtn');
            
            statusBadge.className = 'sync-badge syncing';
            statusBadge.textContent = '‚óè Sincronizando...';
            if(syncBtn) syncBtn.disabled = true;

            try {
                const payload = {
                    acao: acao,
                    timestamp: new Date().toISOString(),
                    ...dados
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.sucesso) {
                    API_STATUS.conectado = true;
                    API_STATUS.ultimaSync = new Date();
                    API_STATUS.tentativas = 0;
                    
                    statusBadge.className = 'sync-badge';
                    statusBadge.textContent = '‚óè Sincronizado';
                    if(syncBtn) syncBtn.disabled = false;
                    
                    console.log(`‚úÖ ${acao} sincronizado:`, result);
                    return { sucesso: true, dados: result.dados };
                } else {
                    throw new Error(result.mensagem || 'Erro desconhecido');
                }

            } catch (erro) {
                console.error(`‚ùå Erro na sincroniza√ß√£o (${acao}):`, erro);
                
                API_STATUS.conectado = false;
                API_STATUS.tentativas++;
                
                statusBadge.className = 'sync-badge error';
                statusBadge.textContent = '‚óè Erro Sync';
                if(syncBtn) syncBtn.disabled = false;
                
                if (API_STATUS.tentativas <= 2) {
                    mostrarNotificacao(`Tentando reconectar... (${API_STATUS.tentativas}/2)`, 'warning');
                } else {
                    mostrarNotificacao('Erro de sincroniza√ß√£o. Dados salvos localmente.', 'error');
                }
                
                return { sucesso: false, erro: erro.toString() };
            }
        }

        async function sincronizarSessao() {
            return await enviarParaSheets('SALVAR_SESSAO', { sessao: session });
        }

        async function sincronizarEmpenho(vtr, empenho) {
            return await enviarParaSheets('SALVAR_EMPENHO', {
                sessao: session,
                vtr: {
                    ...vtr,
                    unitName: units[vtr.unitKey]
                },
                empenho: empenho
            });
        }

        async function sincronizarViatura(vtr) {
            return await enviarParaSheets('SALVAR_VIATURA', {
                sessao: session,
                vtr: {
                    ...vtr,
                    unitName: units[vtr.unitKey]
                }
            });
        }

        async function finalizarSessaoSheets() {
            const result = await enviarParaSheets('FINALIZAR_SESSAO', {
                sessaoId: session.id
            });
            
            if (result.sucesso) {
                mostrarNotificacao('‚úÖ Sess√£o finalizada e sincronizada!', 'success');
            }
            
            return result;
        }

        async function sincronizarTudo() {
            mostrarNotificacao('üîÑ Iniciando sincroniza√ß√£o completa...', 'success');
            
            let sucessos = 0;
            let erros = 0;
            
            // 1. Sincroniza sess√£o
            const sessaoResult = await sincronizarSessao();
            if (sessaoResult.sucesso) sucessos++; else erros++;
            
            // 2. Sincroniza todas as viaturas ativas
            for (const unitKey of session.selectedUnits) {
                const vtrs = unitsData[unitKey]?.vtrs || [];
                for (const vtr of vtrs) {
                    const vtrResult = await sincronizarViatura(vtr);
                    if (vtrResult.sucesso) sucessos++; else erros++;
                    
                    // 3. Sincroniza empenhos da viatura
                    for (const empenho of vtr.empenhos) {
                        const empResult = await sincronizarEmpenho(vtr, empenho);
                        if (empResult.sucesso) sucessos++; else erros++;
                    }
                }
            }
            
            if (erros === 0) {
                mostrarNotificacao(`‚úÖ Sincroniza√ß√£o completa! ${sucessos} itens enviados.`, 'success');
            } else {
                mostrarNotificacao(`‚ö†Ô∏è Sincroniza√ß√£o parcial: ${sucessos} OK, ${erros} erros`, 'warning');
            }
        }

        async function testarConexaoAPI() {
            const statusBadge = document.getElementById('syncStatus');
            const syncBtn = document.getElementById('syncNowBtn');
            
            statusBadge.className = 'sync-badge syncing';
            statusBadge.textContent = '‚óè Testando...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                });
                
                // Se chegou aqui sem erro, a API est√° acess√≠vel
                API_STATUS.conectado = true;
                statusBadge.className = 'sync-badge';
                statusBadge.textContent = '‚óè Conectado';
                if(syncBtn) syncBtn.disabled = false;
                
                console.log('‚úÖ Conex√£o com Google Sheets estabelecida');
                
            } catch (erro) {
                API_STATUS.conectado = false;
                statusBadge.className = 'sync-badge error';
                statusBadge.textContent = '‚óè Desconectado';
                
                console.warn('‚ö†Ô∏è API n√£o acess√≠vel no momento. Trabalhando offline.');
            }
        }

        // ==========================================
        // SISTEMA DE NOTIFICA√á√ïES
        // ==========================================

        function mostrarNotificacao(mensagem, tipo = 'success') {
            const icones = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            const notif = document.createElement('div');
            notif.className = `notification ${tipo}`;
            notif.innerHTML = `
                <div class="notif-icon">${icones[tipo]}</div>
                <div class="notif-text">${mensagem}</div>
            `;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        // ==========================================
        // FUN√á√ïES DE UTILIDADE
        // ==========================================

        function getJText(value){
            const empenho = empenhosJ.find(e => e.value === value);
            return empenho ? empenho.text : value;
        }

        function formatTime(date){
            return new Date(date).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
        }

        function timeDifference(start, end = Date.now()){
            const diffMs = new Date(end) - new Date(start);
            const diffMins = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMins / 60);
            const minutes = diffMins % 60;
            return `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
        }
        
        function findVtrById(id) {
            for (const unitKey of session.selectedUnits) {
                const vtrs = unitsData[unitKey]?.vtrs || [];
                const vtrIndex = vtrs.findIndex(v => v.id.toLowerCase() === id.toLowerCase());
                if (vtrIndex !== -1) {
                    return { unitKey, vtrIndex, vtr: vtrs[vtrIndex], isActive: true };
                }
            }
            return null;
        }

        function applyTheme(theme) {
            const body = document.getElementById('appBody');
            const icon = document.querySelector('.theme-icon');
            const text = document.getElementById('themeText');

            if (theme === 'light') {
                body.classList.add('light-mode');
                if(icon) icon.textContent = '‚òÄÔ∏è';
                if(text) text.textContent = 'Modo Escuro';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                if(icon) icon.textContent = 'üåô';
                if(text) text.textContent = 'Modo Claro';
                localStorage.setItem('theme', 'dark');
            }
            if(empenhosChart) drawCharts();
        }

        function toggleTheme() {
            const currentTheme = document.getElementById('appBody').classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        // ==========================================
        // PERSIST√äNCIA LOCAL
        // ==========================================

        function saveToLocal() {
            if (session.id) {
                const sessionToSave = {
                    session: session,
                    unitsData: unitsData,
                    removedUnitsData: removedUnitsData,
                    vtrHistoryData: vtrHistoryData
                };
                localStorage.setItem('currentSession', JSON.stringify(sessionToSave));
            }
        }

        function loadFromLocal() {
            const savedSession = localStorage.getItem('currentSession');
            if (savedSession) {
                const data = JSON.parse(savedSession);
                session = data.session;
                unitsData = data.unitsData;
                removedUnitsData = data.removedUnitsData || {};
                vtrHistoryData = data.vtrHistoryData || [];

                document.getElementById('operatorName').value = session.operator;
                document.getElementById('dateTime').value = session.datetime.slice(0,16);
                
                session.selectedUnits.forEach(uk => {
                    const cb = document.getElementById(`unit_${uk}`);
                    if (cb) cb.checked = true;
                });

                if (session.operator && session.datetime && session.selectedUnits.length > 0) {
                    document.getElementById('opSummary').textContent = session.operator;
                    document.getElementById('dtSummary').textContent = new Date(session.datetime).toLocaleString('pt-BR');
                    
                    loadFilterUnits();

                    document.getElementById('screen1').style.display = 'none';
                    document.getElementById('screen2').style.display = 'block';

                    renderUnits();
                    updateDashboard();
                    startTimers();
                }
            }
        }

        function loadFilterUnits() {
            const filterUnit = document.getElementById('filterUnit');
            filterUnit.innerHTML = '<option value="">Todas as Unidades</option>';
            session.selectedUnits.forEach(uk=>{
                const opt = document.createElement('option');
                opt.value = uk;
                opt.textContent = units[uk];
                filterUnit.appendChild(opt);
            });
        }

        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================

        (function init(){
            // Testa conex√£o com a API
            testarConexaoAPI();
            
            // Popula seletor de unidades
            const multiSelect = document.getElementById('unitsMultiSelect');
            Object.entries(units).forEach(([k,v])=>{
                const div = document.createElement('div');
                div.className = 'unit-checkbox';
                div.innerHTML = `<input type="checkbox" id="unit_${k}" value="${k}"><label for="unit_${k}">${v}</label>`;
                multiSelect.appendChild(div);
            });

            // Popula empenhos J
            const modalEmpenhoJ = document.getElementById('modalEmpenhoJ');
            const quickModalEmpenhoJ = document.getElementById('quickModalEmpenhoJ');
            empenhosJ.forEach(e=>{
                const opt = document.createElement('option');
                opt.value = e.value;
                opt.textContent = e.text;
                modalEmpenhoJ.appendChild(opt.cloneNode(true));
                quickModalEmpenhoJ.appendChild(opt);
            });

            // Define data/hora atual
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTime').value = now.toISOString().slice(0,16);
            
            // Carrega tema
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            
            // Carrega sess√£o salva
            loadFromLocal();

            // Event listeners
            document.getElementById('quickSearchVtr').addEventListener('input', findVtrForQuickEmpenho);
            document.getElementById('removeUnitBtn').addEventListener('click', removeSelectedUnit);
            document.getElementById('restoreUnitBtn').addEventListener('click', restoreSelectedUnit);
            document.getElementById('saveLocal').addEventListener('click', () => {
                saveToLocal();
                mostrarNotificacao('üíæ Sess√£o salva localmente!', 'success');
            });
        })();

        // ==========================================
        // CONTROLE DE SESS√ÉO
        // ==========================================

        document.getElementById('toStep2').addEventListener('click', async ()=>{
            const op = document.getElementById('operatorName').value.trim();
            const dt = document.getElementById('dateTime').value;
            const selected = Array.from(document.querySelectorAll('#unitsMultiSelect input:checked')).map(cb=>cb.value);

            if(!op || !dt){
                mostrarNotificacao('Preencha o nome do operador e a data/hora.', 'error');
                return;
            }
            if(selected.length === 0){
                mostrarNotificacao('Selecione pelo menos uma unidade para controlar.', 'error');
                return;
            }

            session.operator = op;
            session.datetime = dt;
            session.selectedUnits = selected;
            session.id = Date.now();

            const newUnitsData = {};
            selected.forEach(uk=>{
                 if (removedUnitsData.hasOwnProperty(uk)) {
                     newUnitsData[uk] = removedUnitsData[uk];
                     delete removedUnitsData[uk];
                 } else {
                     newUnitsData[uk] = {vtrs:[]};
                 }
            });
            unitsData = newUnitsData;
            vtrHistoryData = [];

            document.getElementById('opSummary').textContent = op;
            document.getElementById('dtSummary').textContent = new Date(dt).toLocaleString('pt-BR');

            loadFilterUnits();

            document.getElementById('screen1').style.display = 'none';
            document.getElementById('screen2').style.display = 'block';

            renderUnits();
            updateDashboard();
            startTimers();
            saveToLocal();
            
            // Sincroniza sess√£o com Google Sheets
            await sincronizarSessao();
            mostrarNotificacao('‚úÖ Sess√£o iniciada e sincronizada com sucesso!', 'success');
        });

        document.getElementById('finishBtn').addEventListener('click', async function finishSession() {
            if (!confirm('Deseja realmente finalizar o turno atual? Todos os dados ser√£o sincronizados e o turno ser√° encerrado.')) {
                return;
            }

            // Finaliza no Google Sheets
            await finalizarSessaoSheets();

            clearInterval(timerInterval);

            session = {operator:'',datetime:'',selectedUnits:[],id:null};
            unitsData = {};
            removedUnitsData = {};
            vtrHistoryData = [];
            alertsShown = new Set();
            
            localStorage.removeItem('currentSession');

            document.getElementById('screen2').style.display = 'none';
            document.getElementById('screen1').style.display = 'block';

            document.getElementById('operatorName').value = '';
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('dateTime').value = now.toISOString().slice(0,16);
            
            Array.from(document.querySelectorAll('#unitsMultiSelect input:checked')).forEach(cb => cb.checked = false);

            mostrarNotificacao('‚úÖ Turno finalizado com sucesso!', 'success');
        });

        // ==========================================
        // GERENCIAMENTO DE UNIDADES
        // ==========================================

        function openAddUnitModal() {
            const modal = document.getElementById('addUnitModal');
            const container = document.getElementById('unitsToAddContainer');
            container.innerHTML = '';
            
            const unitsNotSelected = Object.keys(units).filter(k => 
                !session.selectedUnits.includes(k) 
            );

            if (unitsNotSelected.length === 0) {
                container.innerHTML = '<p class="small" style="text-align:center;padding:10px;">Todas as unidades dispon√≠veis est√£o ativas.</p>';
                document.getElementById('addUnitsBtn').disabled = true;
            } else {
                document.getElementById('addUnitsBtn').disabled = false;
                unitsNotSelected.forEach(k => {
                    const v = units[k];
                    const hasRemovedData = removedUnitsData.hasOwnProperty(k);
                    const div = document.createElement('div');
                    div.className = 'unit-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="add_unit_${k}" value="${k}">
                        <label for="add_unit_${k}">
                            ${v} ${hasRemovedData ? '(Com Dados Salvos)' : ''}
                        </label>`;
                    container.appendChild(div);
                });
            }

            modal.classList.add('active');
        }

        function closeAddUnitModal() {
            document.getElementById('addUnitModal').classList.remove('active');
        }

        async function addSelectedUnits() {
            const selected = Array.from(document.querySelectorAll('#unitsToAddContainer input:checked')).map(cb => cb.value);

            if (selected.length === 0) {
                mostrarNotificacao('Selecione pelo menos uma unidade para adicionar.', 'error');
                return;
            }

            selected.forEach(uk => {
                if (!session.selectedUnits.includes(uk)) {
                    session.selectedUnits.push(uk);
                    if (removedUnitsData.hasOwnProperty(uk)) {
                         unitsData[uk] = removedUnitsData[uk];
                         delete removedUnitsData[uk];
                    } else {
                         unitsData[uk] = { vtrs: [] };
                    }
                }
            });

            closeAddUnitModal();
            loadFilterUnits();
            renderUnits();
            updateDashboard();
            saveToLocal();
            
            // Sincroniza
            await sincronizarSessao();
            mostrarNotificacao(`‚úÖ ${selected.length} unidade(s) adicionada(s) e sincronizada(s)!`, 'success');
        }

        function openRemoveUnitModal() {
            const modal = document.getElementById('removeUnitModal');
            const select = document.getElementById('unitToRemoveSelect');
            select.innerHTML = '<option value="">Selecione a Unidade</option>';

            const activeUnitsKeys = session.selectedUnits.filter(uk => unitsData.hasOwnProperty(uk));

            if (activeUnitsKeys.length === 0) {
                select.innerHTML = '<option value="" disabled>Nenhuma unidade ativa no controle para remover.</option>';
                document.getElementById('removeUnitBtn').disabled = true;
            } else {
                document.getElementById('removeUnitBtn').disabled = false;
                activeUnitsKeys.forEach(uk => {
                    const numVtrs = unitsData[uk]?.vtrs.length || 0;
                    const opt = document.createElement('option');
                    opt.value = uk;
                    opt.textContent = `${units[uk]} (${numVtrs} VTRs)`;
                    select.appendChild(opt);
                });
            }

            modal.classList.add('active');
        }

        function closeRemoveUnitModal() {
            document.getElementById('removeUnitModal').classList.remove('active');
        }

        async function removeSelectedUnit() {
            const unitKey = document.getElementById('unitToRemoveSelect').value;

            if (!unitKey) {
                mostrarNotificacao('Selecione uma unidade para remover.', 'error');
                return;
            }

            const unitName = units[unitKey];
            const numVtrs = unitsData[unitKey]?.vtrs.length || 0;

            if (!confirm(`Tem certeza que deseja remover a unidade ${unitName} do controle ativo? Os dados das ${numVtrs} viaturas ser√£o salvos no hist√≥rico.`)) {
                return;
            }

            if(unitsData.hasOwnProperty(unitKey)) {
                removedUnitsData[unitKey] = unitsData[unitKey];
            }

            delete unitsData[unitKey];
            session.selectedUnits = session.selectedUnits.filter(uk => uk !== unitKey);

            closeRemoveUnitModal();
            loadFilterUnits();
            renderUnits();
            updateDashboard();
            saveToLocal();
            
            await sincronizarSessao();
            mostrarNotificacao(`‚úÖ Unidade ${unitName} removida e sincronizada!`, 'success');
        }
        
        function openRestoreUnitModal() {
            const modal = document.getElementById('restoreUnitModal');
            const select = document.getElementById('unitToRestoreSelect');
            select.innerHTML = '<option value="">Selecione a Unidade</option>';

            const removedUnitsKeys = Object.keys(removedUnitsData);

            if (removedUnitsKeys.length === 0) {
                select.innerHTML = '<option value="" disabled>Nenhuma unidade no hist√≥rico para restaurar.</option>';
                document.getElementById('restoreUnitBtn').disabled = true;
            } else {
                document.getElementById('restoreUnitBtn').disabled = false;
                removedUnitsKeys.forEach(uk => {
                    const numVtrs = removedUnitsData[uk]?.vtrs.length || 0;
                    const opt = document.createElement('option');
                    opt.value = uk;
                    opt.textContent = `${units[uk]} (${numVtrs} VTRs salvas)`;
                    select.appendChild(opt);
                });
            }

            modal.classList.add('active');
        }

        function closeRestoreUnitModal() {
            document.getElementById('restoreUnitModal').classList.remove('active');
        }

        async function restoreSelectedUnit() {
            const unitKey = document.getElementById('unitToRestoreSelect').value;

            if (!unitKey) {
                mostrarNotificacao('Selecione uma unidade para restaurar.', 'error');
                return;
            }
            
            if (!removedUnitsData.hasOwnProperty(unitKey)) {
                mostrarNotificacao('Erro: Unidade n√£o encontrada no hist√≥rico.', 'error');
                return;
            }

            const unitName = units[unitKey];
            unitsData[unitKey] = removedUnitsData[unitKey];
            
            if (!session.selectedUnits.includes(unitKey)) {
                session.selectedUnits.push(unitKey);
            }

            delete removedUnitsData[unitKey];

            closeRestoreUnitModal();
            loadFilterUnits();
            renderUnits();
            updateDashboard();
            saveToLocal();
            
            await sincronizarSessao();
            mostrarNotificacao(`‚úÖ Unidade ${unitName} restaurada e sincronizada!`, 'success');
        }

        // ==========================================
        // GERENCIAMENTO DE VIATURAS
        // ==========================================

        function openVtrModal(unitKey, vtrIndex = null){
            const modal = document.getElementById('vtrModal');
            const container = document.getElementById('crewInputsContainer');
            container.innerHTML = '';
            editingVtr = {unitKey, vtrIndex};

            if(vtrIndex !== null){
                const vtr = unitsData[unitKey].vtrs[vtrIndex];
                document.getElementById('modalTitle').textContent = `Editar Viatura: ${vtr.id}`;
                document.getElementById('modalVtrId').value = vtr.id;
                document.getElementById('modalServiceType').value = vtr.service;
                document.getElementById('modalVtrPhone').value = vtr.phone || '';
                vtr.crew.forEach(member => addCrewInput(member.name, member.rank));
            } else {
                document.getElementById('modalTitle').textContent = `Adicionar Viatura em ${units[unitKey]}`;
                document.getElementById('modalVtrId').value = '';
                document.getElementById('modalServiceType').value = 'ORDINARIO';
                document.getElementById('modalVtrPhone').value = '';
                for(let i=0; i<3; i++) addCrewInput(); 
            }
            modal.classList.add('active');
        }

        function closeVtrModal(){
            document.getElementById('vtrModal').classList.remove('active');
            editingVtr = null;
        }

        document.getElementById('addCrewMember').addEventListener('click', () => addCrewInput());

        function addCrewInput(name = '', rank = ''){
            const container = document.getElementById('crewInputsContainer');
            if(container.children.length >= 5) return;
            
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = 'crew-input-group';
            div.innerHTML = `
                <div class="crew-input-header">
                    <h4>Membro ${idx + 1}</h4>
                    ${idx > 0 ? `<button type="button" class="danger small" onclick="this.closest('.crew-input-group').remove()">Remover</button>` : ''}
                </div>
                <div class="row">
                    <div class="col">
                        <label>Posto/Gradua√ß√£o</label>
                        <input type="text" class="crew-rank" value="${rank}" placeholder="Ex: Cap, Sgt, Sd" />
                    </div>
                    <div class="col">
                        <label>Nome de Guerra</label>
                        <input type="text" class="crew-name" value="${name}" placeholder="Ex: Silva, Junior" />
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        document.getElementById('saveVtrBtn').addEventListener('click', saveVtr);

        async function saveVtr(){
            const {unitKey, vtrIndex} = editingVtr;
            const id = document.getElementById('modalVtrId').value.trim();
            const service = document.getElementById('modalServiceType').value;
            const phone = document.getElementById('modalVtrPhone').value.trim();
            
            const crew = Array.from(document.querySelectorAll('#crewInputsContainer .crew-input-group')).map(group => ({
                rank: group.querySelector('.crew-rank').value.trim(),
                name: group.querySelector('.crew-name').value.trim(),
            })).filter(m => m.rank || m.name);

            if(!id){
                mostrarNotificacao('A Identifica√ß√£o da Viatura √© obrigat√≥ria.', 'error');
                return;
            }

            const newVtr = {
                id, service, crew, phone, unitKey,
                empenhos: vtrIndex !== null ? unitsData[unitKey].vtrs[vtrIndex].empenhos : []
            };

            if(vtrIndex !== null){
                unitsData[unitKey].vtrs[vtrIndex] = newVtr;
            } else {
                if(unitsData[unitKey].vtrs.some(v => v.id === id)){
                    mostrarNotificacao(`A viatura com ID "${id}" j√° existe nesta unidade.`, 'error');
                    return;
                }
                unitsData[unitKey].vtrs.push(newVtr);
            }

            closeVtrModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
            
            // Sincroniza viatura
            await sincronizarViatura(newVtr);
            mostrarNotificacao(`‚úÖ Viatura ${id} salva e sincronizada!`, 'success');
        }
        
        function deleteVtr(unitKey, vtrIndex){
            const vtr = unitsData[unitKey].vtrs[vtrIndex];
            if(confirm(`Tem certeza que deseja remover a viatura ${vtr.id}? Seus dados ser√£o salvos no hist√≥rico.`)){
                vtrHistoryData.push(vtr);
                unitsData[unitKey].vtrs.splice(vtrIndex, 1);
                
                renderUnits();
                updateDashboard();
                saveToLocal();
                
                mostrarNotificacao(`Viatura ${vtr.id} removida (dados no hist√≥rico)`, 'warning');
            }
        }

        // ==========================================
        // EMPENHOS
        // ==========================================

        function openEmpenhoModal(unitKey, vtrIndex){
            currentVtrForEmpenho = {unitKey, vtrIndex};
            const vtr = unitsData[unitKey].vtrs[vtrIndex];
            document.getElementById('modalVtrName').textContent = vtr.id;
            document.getElementById('modalEmpenhoJ').value = 'J1'; 
            document.getElementById('modalProtocol').value = '';
            document.getElementById('modalActions').value = '';
            document.getElementById('empenhoModal').classList.add('active');
        }

        function closeEmpenhoModal(){
            document.getElementById('empenhoModal').classList.remove('active');
            currentVtrForEmpenho = null;
        }

        document.getElementById('saveEmpenhoBtn').addEventListener('click', saveEmpenho);

        async function saveEmpenho(){
            if(!currentVtrForEmpenho) return;
            const {unitKey, vtrIndex} = currentVtrForEmpenho;
            const vtr = unitsData[unitKey].vtrs[vtrIndex];

            const j = document.getElementById('modalEmpenhoJ').value;
            const protocol = document.getElementById('modalProtocol').value.trim();
            const actions = document.getElementById('modalActions').value.trim();
            
            const empenho = await performEmpenho(vtr, j, protocol, actions);

            closeEmpenhoModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
        }

        document.getElementById('openQuickEmpenhoBtn').addEventListener('click', openQuickEmpenhoModal);

        function openQuickEmpenhoModal() {
            document.getElementById('quickSearchVtr').value = '';
            document.getElementById('quickSearchResult').innerHTML = 'Nenhuma viatura selecionada.';
            document.getElementById('quickEmpenhoForm').style.display = 'none';
            quickEmpenhoVtr = null;
            document.getElementById('quickEmpenhoModal').classList.add('active');
        }

        function closeQuickEmpenhoModal() {
            document.getElementById('quickEmpenhoModal').classList.remove('active');
        }

        function findVtrForQuickEmpenho() {
            const searchId = document.getElementById('quickSearchVtr').value.trim();
            const resultDiv = document.getElementById('quickSearchResult');
            const formDiv = document.getElementById('quickEmpenhoForm');
            quickEmpenhoVtr = null;
            formDiv.style.display = 'none';

            if (searchId.length < 2) {
                resultDiv.innerHTML = 'Digite pelo menos 2 caracteres para buscar.';
                return;
            }

            const found = findVtrById(searchId);

            if (found) {
                quickEmpenhoVtr = found;
                resultDiv.innerHTML = `
                    <div class="found-vtr">
                        Viatura Encontrada: <strong>${found.vtr.id}</strong> (${units[found.unitKey]})
                    </div>
                `;
                const lastEmpenho = found.vtr.empenhos[found.vtr.empenhos.length - 1];
                document.getElementById('quickModalEmpenhoJ').value = (lastEmpenho && lastEmpenho.j !== 'J11') ? lastEmpenho.j : 'J1'; 
                document.getElementById('quickModalProtocol').value = '';
                document.getElementById('quickModalActions').value = '';
                formDiv.style.display = 'block';

            } else {
                resultDiv.innerHTML = `
                    <p>Viatura <strong>${searchId}</strong> n√£o encontrada.</p>
                    <p class="vtr-warning">Certifique-se que a ID esteja correta e que a VTR tenha sido cadastrada.</p>
                `;
            }
        }

        document.getElementById('saveQuickEmpenhoBtn').addEventListener('click', saveQuickEmpenho);

        async function saveQuickEmpenho() {
            if (!quickEmpenhoVtr) {
                mostrarNotificacao('Nenhuma viatura selecionada.', 'error');
                return;
            }

            const vtr = quickEmpenhoVtr.vtr;
            const j = document.getElementById('quickModalEmpenhoJ').value;
            const protocol = document.getElementById('quickModalProtocol').value.trim();
            const actions = document.getElementById('quickModalActions').value.trim();

            await performEmpenho(vtr, j, protocol, actions);

            closeQuickEmpenhoModal();
            renderUnits();
            updateDashboard();
            saveToLocal();
        }

        async function performEmpenho(vtr, j, protocol, actions) {
            const now = new Date().toISOString();
            const newEmpenho = {
                j,
                time: now,
                protocol: protocol || null,
                actions: actions || null
            };
            vtr.empenhos.push(newEmpenho);
            
            // Sincroniza empenho
            await sincronizarEmpenho(vtr, newEmpenho);
            mostrarNotificacao(`‚úÖ Empenho ${j} registrado e sincronizado!`, 'success');
            
            return newEmpenho;
        }

        // ==========================================
        // DASHBOARD E RENDERIZA√á√ÉO
        // ==========================================

        function getAllVtrs() {
            const allVtrs = [];
            
            Object.keys(unitsData).forEach(uk => {
                unitsData[uk]?.vtrs.forEach(vtr => {
                    allVtrs.push({...vtr, unitName: units[uk], unitKey: uk, status: 'ATIVA'});
                });
            });

            Object.keys(removedUnitsData).forEach(uk => {
                removedUnitsData[uk]?.vtrs.forEach(vtr => {
                    allVtrs.push({...vtr, unitName: units[uk], unitKey: uk, status: 'UNIDADE_REMOVIDA'});
                });
            });
            
            vtrHistoryData.forEach(vtr => {
                allVtrs.push({...vtr, unitName: units[vtr.unitKey], unitKey: vtr.unitKey, status: 'VTR_EXCLUIDA'});
            });

            return allVtrs;
        }

        function updateDashboard(){
            const allVtrs = getAllVtrs();
            let totalVtrs = allVtrs.length;
            let totalEmpenhos = 0;
            let empenhoCounts = {};
            let activeVtrs = allVtrs.filter(v => v.status === 'ATIVA').length;

            allVtrs.forEach(vtr=>{
                if(vtr.empenhos && vtr.empenhos.length > 0){
                    totalEmpenhos += vtr.empenhos.length;
                    const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                    empenhoCounts[lastEmpenho.j] = (empenhoCounts[lastEmpenho.j] || 0) + 1;
                }
            });

            const topJ = Object.entries(empenhoCounts).sort((a,b)=>b[1]-a[1])[0];

            const dashboard = document.getElementById('dashboardStats');
            dashboard.innerHTML = `
                <div class="stat-card" style="cursor:pointer;" onclick="openDetailsModal('total')">
                    <div class="stat-label">Viaturas Total (Sess√£o)</div>
                    <div class="stat-value">${totalVtrs}</div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="openDetailsModal('active')">
                    <div class="stat-label">Viaturas Ativas (Controle)</div>
                    <div class="stat-value">${activeVtrs}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Empenhos Total</div>
                    <div class="stat-value">${totalEmpenhos}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">J Mais Usado</div>
                    <div class="stat-value" style="font-size:24px">${topJ ? topJ[0] : '-'}</div>
                </div>
            `;
        }

        function renderUnits(){
            const container = document.getElementById('unitsContainer');
            container.innerHTML = '';
            const search = document.getElementById('searchVtr').value.toLowerCase();
            const filterService = document.getElementById('filterService').value;
            const filterUnit = document.getElementById('filterUnit').value;

            session.selectedUnits.forEach(uk => {
                if(filterUnit && filterUnit !== uk) return;

                const unitContainer = document.createElement('div');
                unitContainer.className = 'unit-card';
                unitContainer.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-title">
                            ${units[uk]}
                            <span class="small" id="vtrCount-${uk}">(${unitsData[uk]?.vtrs.length || 0} Viaturas)</span>
                        </div>
                        <button class="small" onclick="openVtrModal('${uk}', null)">+ Nova VTR</button>
                    </div>
                    <div class="vtr-list" id="vtrList-${uk}"></div>
                `;
                container.appendChild(unitContainer);

                const vtrList = document.getElementById(`vtrList-${uk}`);
                let unitVtrCount = 0;
                
                const vtrs = unitsData[uk]?.vtrs || [];

                vtrs.forEach((vtr, vtrIndex) => {
                    if(filterService && filterService !== vtr.service) return;
                    if(search && !vtr.id.toLowerCase().includes(search) && !vtr.crew.some(m => m.name.toLowerCase().includes(search))) return;
                    
                    unitVtrCount++;

                    const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                    const isAlert = lastEmpenho && ALERT_THRESHOLDS[lastEmpenho.j] && (Date.now() - new Date(lastEmpenho.time)) / 60000 > ALERT_THRESHOLDS[lastEmpenho.j];

                    const vtrItem = document.createElement('div');
                    vtrItem.className = 'vtr-item' + (isAlert ? ' alert' : '');
                    
                    const currentEmpenhoHtml = lastEmpenho ? `
                        <div class="vtr-badges">
                            <span class="vtr-service">${vtr.service}</span>
                            <span class="j-counter">${lastEmpenho.j}</span>
                            ${isAlert ? '<span class="alert-badge">ALERTA</span>' : ''}
                        </div>
                        <div class="vtr-duration" data-time="${lastEmpenho.time}">
                            ${timeDifference(lastEmpenho.time)}
                        </div>
                    ` : `
                        <div class="vtr-badges">
                            <span class="vtr-service">${vtr.service}</span>
                            <span class="j-counter" style="background:rgba(255,255,255,0.1);color:var(--text-muted)">Em Base</span>
                        </div>
                    `;

                    vtrItem.innerHTML = `
                        <div class="vtr-info">
                            <div class="vtr-id">üöî ${vtr.id}</div>
                            ${currentEmpenhoHtml}
                        </div>
                        <div class="vtr-actions">
                            <button class="small success" onclick="openEmpenhoModal('${uk}', ${vtrIndex})">J +</button>
                            <button class="small ghost" onclick="openVtrDetailsModal('${uk}', ${vtrIndex})">Detalhes</button>
                            <button class="small danger" onclick="deleteVtr('${uk}', ${vtrIndex})">Excluir</button>
                        </div>
                    `;

                    vtrList.appendChild(vtrItem);
                });
                
                document.getElementById(`vtrCount-${uk}`).textContent = `(${unitVtrCount} Viaturas)`;
            });
        }
        
        document.getElementById('searchVtr').addEventListener('input', renderUnits);
        document.getElementById('filterService').addEventListener('change', renderUnits);
        document.getElementById('filterUnit').addEventListener('change', renderUnits);

        function startTimers(){
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                renderUnits(); 
                checkTimeAlerts(); 
            }, 5000);
        }

        function checkTimeAlerts(){
            const now = Date.now();
            session.selectedUnits.forEach(uk=>{
                const vtrs = unitsData[uk]?.vtrs || [];
                vtrs.forEach((vtr,idx)=>{
                    if(!vtr.empenhos || vtr.empenhos.length === 0) return;
                    
                    const lastEmpenho = vtr.empenhos[vtr.empenhos.length - 1];
                    const duration = (now - new Date(lastEmpenho.time)) / 60000;
                    const threshold = ALERT_THRESHOLDS[lastEmpenho.j];
                    
                    const alertKey = `${uk}-${idx}-${lastEmpenho.time}`;
                    
                    if(threshold && duration > threshold && !alertsShown.has(alertKey)){
                        alertsShown.add(alertKey);
                        showAlert(vtr.id, lastEmpenho.j, Math.floor(duration));
                    }
                });
            });
        }

        function showAlert(vtrId, j, mins){
            if(Notification.permission === 'granted'){
                new Notification('‚ö†Ô∏è Alerta de Tempo', {
                    body: `${vtrId} est√° em ${j} h√° ${mins} minutos`,
                    icon: 'üöî'
                });
            }
            mostrarNotificacao(`‚ö†Ô∏è ${vtrId} em ${j} h√° ${mins} minutos!`, 'warning');
        }

        if('Notification' in window && Notification.permission === 'default'){
            Notification.requestPermission();
        }

        // ==========================================
        // MODAIS DE DETALHES
        // ==========================================

        function openDetailsModal(type) {
            const modal = document.getElementById('detailsModal');
            const title = document.getElementById('detailsModalTitle');
            const content = document.getElementById('detailsModalContent');
            content.innerHTML = '';

            title.textContent = type === 'total' ? 'Detalhes: Todas as Viaturas (Ativas/Hist√≥rico)' : 'Detalhes: Viaturas Ativas no Controle';

            const allVtrs = getAllVtrs();

            let filteredVtrs = allVtrs.filter(vtr => {
                if (type === 'total') return true;
                return vtr.status === 'ATIVA';
            });
            
            filteredVtrs = filteredVtrs.map(vtr => {
                if (vtr.status === 'ATIVA') {
                    const unitVtrs = unitsData[vtr.unitKey]?.vtrs || [];
                    const vtrIndex = unitVtrs.findIndex(item => item.id === vtr.id);
                    return { ...vtr, vtrIndex };
                }
                return vtr;
            });

            if (filteredVtrs.length === 0) {
                content.innerHTML = '<p class="small" style="text-align:center;padding:20px;">Nenhuma viatura encontrada.</p>';
                modal.classList.add('active');
                return;
            }

            filteredVtrs.forEach(vtr => {
                const item = document.createElement('div');
                const lastEmpenho = vtr.empenhos.length > 0 ? vtr.empenhos[vtr.empenhos.length - 1] : null;
                const isAlert = lastEmpenho && ALERT_THRESHOLDS[lastEmpenho.j] && (Date.now() - new Date(lastEmpenho.time)) / 60000 > ALERT_THRESHOLDS[lastEmpenho.j];
                item.className = 'vtr-item' + (isAlert ? ' alert' : '');
                
                let statusHtml = '<div class="j-counter" style="background:rgba(255,255,255,0.1);color:var(--text-muted)">Sem Empenho J</div>';
                
                if (lastEmpenho) {
                    const duration = timeDifference(lastEmpenho.time);
                    statusHtml = `
                        <div class="vtr-badges">
                            <span class="vtr-service">${vtr.service}</span>
                            <span class="j-counter">${duration}</span>
                        </div>
                    `;
                }
                
                let statusBadge = '';
                if (vtr.status === 'UNIDADE_REMOVIDA') {
                     statusBadge = '<span class="alert-badge" style="background:var(--text-muted);margin-left:8px;">UNIDADE REMOVIDA</span>';
                } else if (vtr.status === 'VTR_EXCLUIDA') {
                     statusBadge = '<span class="alert-badge" style="background:var(--danger);margin-left:8px;">VTR EXCLU√çDA</span>';
                }
                
                const showDetailsButton = vtr.status === 'ATIVA' ? 
                    `<button class="small ghost" onclick="event.stopPropagation(); openVtrDetailsModal('${vtr.unitKey}', ${vtr.vtrIndex})">Ver Detalhes</button>` : 
                    `<button class="small ghost" onclick="event.stopPropagation(); openVtrHistoryDetailsModal('${vtr.unitKey}', '${vtr.id}', '${vtr.status}')">Ver Hist√≥rico</button>`;

                item.innerHTML = `
                    <div class="vtr-info">
                        <div class="vtr-id">
                            ${vtr.id}
                            ${statusBadge}
                            ${isAlert && vtr.status === 'ATIVA' ? '<span class="alert-badge">ALERTA TEMPO!</span>' : ''}
                        </div>
                        ${statusHtml}
                    </div>
                    <div class="small">
                        Unidade: ${vtr.unitName} | Servi√ßo: ${lastEmpenho ? getJText(lastEmpenho.j) : 'VTR em Base'}
                    </div>
                    ${lastEmpenho ? `<div class="small" style="margin-top:4px;">In√≠cio: ${formatTime(lastEmpenho.time)}</div>` : ''}
                    <div class="vtr-actions">
                        ${showDetailsButton}
                    </div>
                `;
                content.appendChild(item);
            });

            modal.classList.add('active');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        function openVtrDetailsModal(unitKey, vtrIndex) {
            const modal = document.getElementById('vtrDetailsModal');
            const title = document.getElementById('vtrDetailsModalTitle');
            const content = document.getElementById('vtrDetailsModalContent');
            content.innerHTML = '';
            
            let vtr = unitsData[unitKey].vtrs[vtrIndex];
            
            if (!vtr) {
                 content.innerHTML = '<p class="small" style="text-align:center;padding:20px;">Detalhes n√£o encontrados.</p>';
                 modal.classList.add('active');
                 return;
            }

            title.textContent = `Hist√≥rico: üöî ${vtr.id} (${units[unitKey]})`;

            const headerHtml = `
                <div style="margin-bottom:15px; background:rgba(6,182,212,0.1); padding:15px; border-radius:8px;">
                    <h4 style="margin:0; color:var(--accent);">Informa√ß√µes da Viatura</h4>
                    <div class="small" style="margin-top:5px;">
                        <strong>Servi√ßo:</strong> ${vtr.service} | <strong>Telefone:</strong> ${vtr.phone || 'N/A'}
                    </div>
                    <div class="small" style="margin-top:5px;">
                        <strong>Tripula√ß√£o:</strong> ${vtr.crew.map(m => `${m.rank} ${m.name}`).filter(s => s.trim()).join(' / ') || 'N√£o informada'}
                    </div>
                </div>
                
                <h3 style="margin-top:20px;">Hist√≥rico de Empenhos (${vtr.empenhos.length} Registros)</h3>
            `;
            content.innerHTML += headerHtml;
            
            if (vtr.empenhos.length === 0) {
                content.innerHTML += '<p class="small" style="text-align:center;">Nenhum empenho registrado.</p>';
            } else {
                vtr.empenhos.slice().reverse().forEach((empenho, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'empenho-history-item';
                    
                    const time = new Date(empenho.time).toLocaleString('pt-BR');
                    
                    let durationHtml = '';
                    if (index < vtr.empenhos.length - 1) {
                         const nextEmpenho = vtr.empenhos[vtr.empenhos.length - 2 - index];
                         const duration = timeDifference(empenho.time, nextEmpenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--success);">Dura√ß√£o: ${duration}</span>`;
                    } else if (index === 0) {
                        const duration = timeDifference(empenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--warning);">Dura√ß√£o Atual: ${duration}</span>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${empenho.j}: ${getJText(empenho.j).split(': ')[1]}</strong>
                            ${durationHtml}
                        </div>
                        <div class="small">
                            In√≠cio: ${time} ${empenho.protocol ? `| Protocolo: <strong>${empenho.protocol}</strong>` : ''}
                        </div>
                        ${empenho.actions ? `
                            <div class="small" style="margin-top:5px;"><strong>A√ß√µes:</strong></div>
                            <pre>${empenho.actions}</pre>
                        ` : ''}
                    `;
                    content.appendChild(itemDiv);
                });
            }

            modal.classList.add('active');
        }

        function closeVtrDetailsModal() {
            document.getElementById('vtrDetailsModal').classList.remove('active');
        }

        function openVtrHistoryDetailsModal(unitKey, vtrId, status) {
            const modal = document.getElementById('vtrDetailsModal');
            const title = document.getElementById('vtrDetailsModalTitle');
            const content = document.getElementById('vtrDetailsModalContent');
            content.innerHTML = '';
            
            let vtr = null;
            
            if (status === 'VTR_EXCLUIDA') {
                vtr = vtrHistoryData.find(v => v.id === vtrId && v.unitKey === unitKey);
            } else if (status === 'UNIDADE_REMOVIDA' && removedUnitsData[unitKey]) {
                vtr = removedUnitsData[unitKey].vtrs.find(v => v.id === vtrId);
            }
            
            if (!vtr) {
                 content.innerHTML = '<p class="small" style="text-align:center;padding:20px;">Detalhes n√£o encontrados.</p>';
                 modal.classList.add('active');
                 return;
            }

            title.textContent = `Hist√≥rico (${status.replace('_', ' ')}): üöî ${vtr.id}`;

            const headerHtml = `
                <div style="margin-bottom:15px; background:rgba(6,182,212,0.1); padding:15px; border-radius:8px;">
                    <h4 style="margin:0; color:var(--accent);">Informa√ß√µes da Viatura</h4>
                    <div class="small" style="margin-top:5px;">
                        <strong>Servi√ßo:</strong> ${vtr.service} | <strong>Unidade:</strong> ${units[unitKey]}
                    </div>
                    <div class="small" style="margin-top:5px;">
                        <strong>Tripula√ß√£o:</strong> ${vtr.crew.map(m => `${m.rank} ${m.name}`).filter(s => s.trim()).join(' / ') || 'N√£o informada'}
                    </div>
                </div>
                
                <h3 style="margin-top:20px;">Hist√≥rico de Empenhos (${vtr.empenhos.length} Registros)</h3>
            `;
            content.innerHTML += headerHtml;

            if (vtr.empenhos.length === 0) {
                content.innerHTML += '<p class="small" style="text-align:center;">Nenhum empenho registrado.</p>';
            } else {
                vtr.empenhos.slice().reverse().forEach((empenho, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'empenho-history-item';
                    
                    const time = new Date(empenho.time).toLocaleString('pt-BR');
                    
                    let durationHtml = '';
                    if (index < vtr.empenhos.length - 1) {
                         const nextEmpenho = vtr.empenhos[vtr.empenhos.length - 2 - index];
                         const duration = timeDifference(empenho.time, nextEmpenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--success);">Dura√ß√£o: ${duration}</span>`;
                    } else if (index === 0) {
                        const duration = timeDifference(empenho.time);
                         durationHtml = `<span style="margin-left:15px; font-weight:600; color:var(--warning);">Dura√ß√£o Atual: ${duration}</span>`;
                    }
                    
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${empenho.j}: ${getJText(empenho.j).split(': ')[1]}</strong>
                            ${durationHtml}
                        </div>
                        <div class="small">
                            In√≠cio: ${time} ${empenho.protocol ? `| Protocolo: <strong>${empenho.protocol}</strong>` : ''}
                        </div>
                        ${empenho.actions ? `
                            <div class="small" style="margin-top:5px;"><strong>A√ß√µes:</strong></div>
                            <pre>${empenho.actions}</pre>
                        ` : ''}
                    `;
                    content.appendChild(itemDiv);
                });
            }

            modal.classList.add('active');
        }

        // ==========================================
        // ESTAT√çSTICAS
        // ==========================================

        document.getElementById('openStatsBtn').addEventListener('click', openStatsModal);

        function openStatsModal() {
            document.getElementById('statsModal').classList.add('active');
            switchTab('charts');
            generateStatistics();
            drawCharts();
            generatePerformanceStats();
            generateServiceUnitStats();
            generateOcurrenceList();
        }

        function closeStatsModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        function generateStatistics() {
            const stats = {
                empenhoCounts: {}, 
                hourCounts: {},    
                durations: [],     
            };
            
            const allVtrs = getAllVtrs();

            allVtrs.forEach(vtr => {
                vtr.empenhos.forEach((empenho, index) => {
                    stats.empenhoCounts[empenho.j] = (stats.empenhoCounts[empenho.j] || 0) + 1;

                    const hour = new Date(empenho.time).getHours();
                    stats.hourCounts[hour] = (stats.hourCounts[hour] || 0) + 1;

                    if (index > 0) {
                        const prevEmpenho = vtr.empenhos[index - 1];
                        const startTime = new Date(prevEmpenho.time).getTime();
                        const endTime = new Date(empenho.time).getTime();
                        const durationMins = Math.floor((endTime - startTime) / 60000);
                        stats.durations.push({
                            j: prevEmpenho.j,
                            duration: durationMins
                        });
                    }
                });
            });

            return stats;
        }

        function drawCharts() {
            const stats = generateStatistics();
            const isDarkMode = !document.getElementById('appBody').classList.contains('light-mode');
            const textColor = isDarkMode ? '#94a3b8' : '#1f2937';
            const accentColor = isDarkMode ? '#06b6d4' : '#0284c7';
            const warningColor = isDarkMode ? '#f59e0b' : '#d97706';

            if (empenhosChart) empenhosChart.destroy();
            const empenhoLabels = Object.keys(stats.empenhoCounts).sort();
            const empenhoData = empenhoLabels.map(label => stats.empenhoCounts[label]);

            const ctxEmpenhos = document.getElementById('chartEmpenhos').getContext('2d');
            empenhosChart = new Chart(ctxEmpenhos, {
                type: 'bar',
                data: {
                    labels: empenhoLabels,
                    datasets: [{
                        label: 'Ocorr√™ncias/Atividades',
                        data: empenhoData,
                        backgroundColor: `${accentColor}99`,
                        borderColor: accentColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } 
                        },
                        x: { 
                            ticks: { color: textColor },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } 
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });

            if (horarioChart) horarioChart.destroy();
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}h`);
            const hourData = hourLabels.map((_, i) => stats.hourCounts[i] || 0);

            const ctxHorario = document.getElementById('chartHorario').getContext('2d');
            horarioChart = new Chart(ctxHorario, {
                type: 'line',
                data: {
                    labels: hourLabels,
                    datasets: [{
                        label: 'Total de Empenhos',
                        data: hourData,
                        borderColor: warningColor,
                        backgroundColor: `${warningColor}33`,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } 
                        },
                        x: { 
                            ticks: { color: textColor },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } 
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });
        }

        function generatePerformanceStats() {
            const container = document.getElementById('performanceStats');
            container.innerHTML = '';

            const allVtrs = getAllVtrs();
            let allVtrStats = [];
            let totalEmpenhosFinalizados = 0;
            let totalTempo = 0;
            
            allVtrs.forEach(vtr => {
                if (vtr.empenhos.length > 0) {
                    const vtrStats = {
                        id: vtr.id,
                        unit: vtr.unitName,
                        unitKey: vtr.unitKey,
                        status: vtr.status,
                        totalEmpenhos: vtr.empenhos.length,
                        empenhosFinalizados: 0,
                        lastJ: vtr.empenhos[vtr.empenhos.length - 1].j,
                        mediaTempoMins: 0,
                        vtrIndex: vtr.status === 'ATIVA' ? unitsData[vtr.unitKey].vtrs.findIndex(item => item.id === vtr.id) : null 
                    };
                    
                    let totalDurationMins = 0;
                    let finishedEmpenhosCount = 0;

                    for (let i = 1; i < vtr.empenhos.length; i++) {
                        const prevEmpenho = vtr.empenhos[i - 1];
                        const currentEmpenho = vtr.empenhos[i];

                        const startTime = new Date(prevEmpenho.time).getTime();
                        const endTime = new Date(currentEmpenho.time).getTime();
                        const durationMins = Math.floor((endTime - startTime) / 60000);
                        
                        totalDurationMins += durationMins;
                        finishedEmpenhosCount++;
                    }

                    vtrStats.empenhosFinalizados = finishedEmpenhosCount;
                    vtrStats.mediaTempoMins = finishedEmpenhosCount > 0 
                        ? Math.round(totalDurationMins / finishedEmpenhosCount) 
                        : 0;

                    totalEmpenhosFinalizados += finishedEmpenhosCount;
                    totalTempo += totalDurationMins;

                    allVtrStats.push(vtrStats);
                }
            });

            if (allVtrStats.length === 0) {
                container.innerHTML = '<p class="small" style="padding:20px;text-align:center;">Nenhuma viatura com empenhos registrados.</p>';
                return;
            }

            const mediaGeral = totalEmpenhosFinalizados > 0 ? Math.round(totalTempo / totalEmpenhosFinalizados) : 0;
            const activeVtrsPerformance = allVtrStats.filter(v => v.status === 'ATIVA');

            let performanceHtml = `
                <div class="card" style="margin-bottom:12px;display:flex;gap:16px;justify-content:space-around;">
                    <div style="text-align:center;">
                        <div class="stat-label">Total de Empenhos Finalizados</div>
                        <div class="stat-value" style="font-size:24px;color:var(--success);">${totalEmpenhosFinalizados}</div>
                    </div>
                    <div style="text-align:center;">
                        <div class="stat-label">Tempo M√©dio Total (min)</div>
                        <div class="stat-value" style="font-size:24px;color:var(--accent);">${mediaGeral}m</div>
                    </div>
                </div>

                <h3>Desempenho das Viaturas Ativas</h3>
                ${activeVtrsPerformance.length > 0 ? `
                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Viatura</th>
                            <th>Unidade</th>
                            <th>J's Finalizados</th>
                            <th>J Atual</th>
                            <th>M√©dia (min)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${activeVtrsPerformance.map(vtr => `
                            <tr style="cursor:pointer;" onclick="openVtrDetailsModal('${vtr.unitKey}', ${vtr.vtrIndex})">
                                <td style="font-weight:600;">üöî ${vtr.id}</td>
                                <td style="font-size:13px;">${vtr.unit}</td>
                                <td>${vtr.empenhosFinalizados}</td>
                                <td style="font-weight:600;color:var(--warning);">${vtr.lastJ}</td>
                                <td style="color:var(--accent);">${vtr.mediaTempoMins}m</td>
                                <td><button class="small ghost" onclick="event.stopPropagation(); openVtrDetailsModal('${vtr.unitKey}', ${vtr.vtrIndex})">Ver</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : '<p class="small" style="text-align:center;padding:10px;">Nenhuma viatura ativa.</p>'}
            `;

            container.innerHTML = performanceHtml;
        }

        function generateServiceUnitStats() {
            const container = document.getElementById('serviceUnitStats');
            container.innerHTML = '';

            const allVtrs = getAllVtrs();
            const stats = {};
            const unitKeys = new Set();
            let totalVtrs = 0;

            allVtrs.forEach(vtr => {
                const unitKey = vtr.unitKey;
                const service = vtr.service;
                unitKeys.add(unitKey);
                totalVtrs++;

                if (!stats[unitKey]) {
                    stats[unitKey] = {
                        name: vtr.unitName,
                        total: 0,
                        services: {
                            'ORDINARIO': 0, 'SEG': 0, 'POG': 0, 'OPERA√á√ÉO': 0
                        }
                    };
                }
                
                stats[unitKey].total++;
                if (stats[unitKey].services.hasOwnProperty(service)) {
                    stats[unitKey].services[service]++;
                } else {
                    stats[unitKey].services['OUTRO'] = (stats[unitKey].services['OUTRO'] || 0) + 1;
                }
            });

            const sortedUnitKeys = Array.from(unitKeys).sort((a, b) => units[a].localeCompare(units[b]));
            
            if (totalVtrs === 0) {
                 container.innerHTML = '<p class="small" style="padding:20px;text-align:center;">Nenhuma viatura registrada.</p>';
                 return;
            }

            let tableHtml = `
                <h3 style="margin-bottom:12px;">Quantitativo por Tipo de Servi√ßo</h3>
                <div class="card" style="margin-bottom:16px; text-align:center;">
                    <div class="stat-label">Total de Viaturas</div>
                    <div class="stat-value">${totalVtrs}</div>
                </div>

                <table class="service-table">
                    <thead>
                        <tr>
                            <th>Unidade</th>
                            <th>ORDIN√ÅRIO</th>
                            <th>SEG</th>
                            <th>POG</th>
                            <th>OPERA√á√ÉO</th>
                            <th>OUTROS</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let grandTotal = {
                ORDINARIO: 0, SEG: 0, POG: 0, OPERA√á√ÉO: 0, OUTRO: 0, TOTAL: 0
            };

            sortedUnitKeys.forEach(uk => {
                const unitStats = stats[uk];
                const services = unitStats.services;

                grandTotal.ORDINARIO += services.ORDINARIO;
                grandTotal.SEG += services.SEG;
                grandTotal.POG += services.POG;
                grandTotal.OPERA√á√ÉO += services.OPERA√á√ÉO;
                grandTotal.OUTRO += services.OUTRO || 0;
                grandTotal.TOTAL += unitStats.total;

                tableHtml += `
                    <tr>
                        <td style="font-weight:600;">${unitStats.name}</td>
                        <td>${services.ORDINARIO || 0}</td>
                        <td>${services.SEG || 0}</td>
                        <td>${services.POG || 0}</td>
                        <td>${services.OPERA√á√ÉO || 0}</td>
                        <td>${services.OUTRO || 0}</td>
                        <td style="font-weight:700; color:var(--accent);">${unitStats.total}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                    <tfoot>
                        <tr style="border-top: 2px solid var(--accent); background: var(--glass); font-weight: 700;">
                            <td>Total Geral:</td>
                            <td>${grandTotal.ORDINARIO}</td>
                            <td>${grandTotal.SEG}</td>
                            <td>${grandTotal.POG}</td>
                            <td>${grandTotal.OPERA√á√ÉO}</td>
                            <td>${grandTotal.OUTRO}</td>
                            <td style="color:var(--danger);">${grandTotal.TOTAL}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }

        function generateOcurrenceList() {
            const container = document.getElementById('occurrenceList');
            container.innerHTML = '';
            const searchProtocol = document.getElementById('searchProtocol').value.toLowerCase().trim();
            
            const empenhosComDados = [];
            const allVtrs = getAllVtrs();

            allVtrs.forEach(vtr => {
                vtr.empenhos.forEach(empenho => {
                    if (empenho.protocol || empenho.actions) {
                        empenhosComDados.push({
                            unit: vtr.unitName,
                            vtrId: vtr.id,
                            j: empenho.j,
                            protocol: empenho.protocol,
                            actions: empenho.actions,
                            time: empenho.time
                        });
                    }
                });
            });

            empenhosComDados.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            const filteredEmpenhos = empenhosComDados.filter(item => {
                if (!searchProtocol) return true;
                return item.protocol && item.protocol.toLowerCase().includes(searchProtocol);
            });

            if (filteredEmpenhos.length === 0) {
                 container.innerHTML = `<p class="small" style="padding:20px;text-align:center;">Nenhuma ocorr√™ncia encontrada.</p>`;
                 return;
            }

            filteredEmpenhos.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'occurrence-item';
                
                const protocolHtml = item.protocol 
                    ? `<span class="occurrence-protocol">Protocolo: ${item.protocol}</span>`
                    : '<span class="occurrence-protocol" style="background:var(--glass);color:var(--text-muted)">Sem Protocolo</span>';

                itemDiv.innerHTML = `
                    <div class="occurrence-header">
                        <div>
                            <div class="occurrence-vtr">üöî ${item.vtrId} (${item.unit})</div>
                            <div class="small" style="color:var(--text-muted);margin-top:2px;">${new Date(item.time).toLocaleString('pt-BR')}</div>
                        </div>
                        ${protocolHtml}
                    </div>
                    <div class="occurrence-j">${item.j}: ${getJText(item.j).split(': ')[1]}</div>
                    <div class="occurrence-actions">
                        <strong>A√ß√µes:</strong> 
                        ${item.actions || '<em style="color:var(--text-muted)">Nenhuma a√ß√£o registrada.</em>'}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            if (tabId === 'charts') {
                drawCharts();
            } else if (tabId === 'performance') {
                generatePerformanceStats();
            } else if (tabId === 'service_unit') {
                generateServiceUnitStats();
            } else if (tabId === 'occurrences') { 
                generateOcurrenceList();
            }
        }

        // ==========================================
        // EXPORTA√á√ÉO PDF/CSV
        // ==========================================

        function getFullEmpenhoData() {
            let data = [];
            const allVtrs = getAllVtrs();

            allVtrs.forEach(vtr => {
                vtr.empenhos.forEach(empenho => {
                    data.push({
                        'ID_SESSAO': session.id,
                        'UNIDADE': vtr.unitName,
                        'STATUS_CONTROLE': vtr.status,
                        'ID_VTR': vtr.id,
                        'SERVICO_VTR': vtr.service,
                        'J': empenho.j,
                        'DESCRICAO_J': getJText(empenho.j).split(': ')[1],
                        'HORA_INICIO': new Date(empenho.time).toLocaleString('pt-BR'),
                        'PROTOCOLO': empenho.protocol || '',
                        'ACOES_EMPREGADAS': empenho.actions ? empenho.actions.replace(/(\r\n|\n|\r)/gm, " ").trim() : ''
                    });
                });
            });
            return data;
        }

        document.getElementById('exportCsv').addEventListener('click', exportCsv);

        function exportCsv() {
            const data = getFullEmpenhoData();
            if (data.length === 0) {
                mostrarNotificacao('Nenhum dado para exportar.', 'error');
                return;
            }

            const headers = Object.keys(data[0]);
            let csv = [headers.join(';')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let val = row[header];
                    if (typeof val === 'string' && (val.includes(';') || val.includes('\n'))) {
                         val = `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                });
                csv.push(values.join(';'));
            });
            
            const csvContent = "\ufeff" + csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `Mapa_Forca_${session.id}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('‚úÖ CSV exportado com sucesso!', 'success');
        }

        document.getElementById('exportPdf').addEventListener('click', exportPdf);

        function exportPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            let y = 10;
            
            doc.setFontSize(16);
            doc.text('Relat√≥rio do Mapa da For√ßa', 10, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.text(`Operador: ${session.operator}`, 10, y);
            doc.text(`In√≠cio: ${new Date(session.datetime).toLocaleString('pt-BR')}`, 100, y);
            y += 10;
            
            const empenhoData = getFullEmpenhoData();
            const tableColumns = [
                { header: 'VTR', dataKey: 'ID_VTR' },
                { header: 'Unidade', dataKey: 'UNIDADE' },
                { header: 'J', dataKey: 'J' },
                { header: 'In√≠cio', dataKey: 'HORA_INICIO' },
                { header: 'Protocolo', dataKey: 'PROTOCOLO' },
            ];
            
            const tableRows = empenhoData.map(row => tableColumns.map(col => row[col.dataKey]));
            
            doc.autoTable({
                startY: y,
                head: [tableColumns.map(c => c.header)],
                body: tableRows,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [6, 182, 212] },
            });

            doc.save(`Mapa_Forca_${session.id}.pdf`);
            mostrarNotificacao('‚úÖ PDF exportado com sucesso!', 'success');
        }

    </script>
</body>
</html>
